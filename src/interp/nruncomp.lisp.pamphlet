\documentclass{article}
\usepackage{axiom}
\begin{document}
\title{\$SPAD/src/interp nruncomp.lisp}
\author{The Axiom Team}
\maketitle
\begin{abstract}
\end{abstract}
\eject
\tableofcontents
\eject
\begin{chunk}{*}
(IN-PACKAGE "BOOT" )

;-----------------------------NEW buildFunctor CODE-----------------------------
;NRTaddDeltaCode() ==
;--NOTES: This function is called from NRTbuildFunctor to initially
;--  fill slots in $template. The $template so created is stored in the
;--  nrlib. On load, makeDomainTemplate is called on this $template to
;--  create a template which becomes slot 0 of the infovec for the constructor.
;--The template has 6 kinds of entries:
;--  (1) formal arguments and local variables, represented by (QUOTE <entry>)
;--      this conflicts by (5) but is ok since each is explicitly set by
;--      instantiator code;
;--  (2) domains, represented by lazy forms, e.g. (Foo 12 17 6)
;--  (3) latch slots, represented SPADCALLable forms which goGet an operation
;--      from a domain then cache the operation in the same slot
;--  (4) functions, represented by identifiers which are names of functions
;--  (5) identifiers/strings, parts of signatures (now parts of signatures
;--      now must all have slot numbers, represented by (QUOTE <entry>)
;--  (6) constants, like 0 and 1, represented by (CONS .. ) form
;  kvec := first $catvecList
;  for i in $NRTbase.. for item in REVERSE $NRTdeltaList
;    for compItem in REVERSE $NRTdeltaListComp
;      |null (s:=kvec.i) repeat
;        $template.i:= deltaTran(item,compItem)
;  $template.5 :=
;    $NRTaddForm =>
;      $NRTaddForm is ['Tuple,:y] => NREVERSE y
;      NRTencode($NRTaddForm,$addForm)
;    nil

(DEFUN |NRTaddDeltaCode| ()
  (PROG (|kvec| |s| |y|)
  (declare (special |$addForm| |$NRTaddForm| |$template| |$NRTdeltaListComp|
                    |$NRTdeltaList| |$NRTbase| |$catvecList|)) 
    (RETURN
      (SEQ (PROGN
             (setq |kvec| (CAR |$catvecList|))
             (DO ((|i| |$NRTbase| (+ |i| 1))
                  (G166066 (REVERSE |$NRTdeltaList|) (CDR G166066))
                  (|item| NIL)
                  (G166067 (REVERSE |$NRTdeltaListComp|)
                      (CDR G166067))
                  (|compItem| NIL))
                 ((OR (ATOM G166066)
                      (PROGN (SETQ |item| (CAR G166066)) NIL)
                      (ATOM G166067)
                      (PROGN (SETQ |compItem| (CAR G166067)) NIL))
                  NIL)
               (SEQ (EXIT (COND
                            ((NULL (setq |s| (ELT |kvec| |i|)))
                             (SETELT |$template| |i|
                                     (|deltaTran| |item| |compItem|)))))))
             (SETELT |$template| 5
                     (COND
                       (|$NRTaddForm|
                           (COND
                             ((AND (CONSP |$NRTaddForm|)
                                   (EQ (QCAR |$NRTaddForm|) '|@Tuple|)
                                   (PROGN
                                     (setq |y| (QCDR |$NRTaddForm|))
                                     'T))
                              (NREVERSE |y|))
                             ('T
                              (|NRTencode| |$NRTaddForm| |$addForm|))))
                       ('T NIL))))))))

;deltaTran(item,compItem) ==
;  item is ['domain,lhs,:.] => NRTencode(lhs,compItem)
;  --NOTE: all items but signatures are wrapped with domain forms
;  [op,:modemap] := item
;  [dcSig,[.,[kind,:.]]] := modemap
;  [dc,:sig] := dcSig
;  sig := substitute('$,dc,substitute("$$",'$,sig))
;  dcCode :=
;    dc = '$ =>
;      --$NRTaddForm => -5
;      0
;    NRTassocIndexAdd dc or keyedSystemError("S2NR0004",[dc])
;  formalSig:= SUBLISLIS($FormalMapVariableList,$formalArgList,sig)
;  kindFlag:= (kind = 'CONST => 'CONST; nil)
;  newSig := [NRTassocIndex x or x for x in formalSig]
;  [newSig,dcCode,op,:kindFlag]

(DEFUN |deltaTran| (|item| |compItem|)
  (PROG (|ISTMP#1| |lhs| |op| |modemap| |dcSig| |kind| |dc| |sig|
            |dcCode| |formalSig| |kindFlag| |newSig|)
  (declare (special |$formalArgList| |$FormalMapVariableList|))
    (RETURN
      (SEQ (COND
             ((AND (CONSP |item|) (EQ (QCAR |item|) '|domain|)
                   (PROGN
                     (setq |ISTMP#1| (QCDR |item|))
                     (AND (CONSP |ISTMP#1|)
                          (PROGN (setq |lhs| (QCAR |ISTMP#1|)) 'T))))
              (|NRTencode| |lhs| |compItem|))
             ('T (setq |op| (CAR |item|))
              (setq |modemap| (CDR |item|))
              (setq |dcSig| (CAR |modemap|))
              (setq |kind| (CAR (CADADR |modemap|)))
              (setq |dc| (CAR |dcSig|))
              (setq |sig| (CDR |dcSig|))
              (setq |sig| (MSUBST '$ |dc| (MSUBST '$$ '$ |sig|)))
              (setq |dcCode|
                       (COND
                         ((BOOT-EQUAL |dc| '$) 0)
                         ('T
                          (OR (|NRTassocIndexAdd| |dc|)
                              (|keyedSystemError|
                               "Cannot find domain in template: %1s"
                                  (CONS |dc| NIL))))))
              (setq |formalSig|
                       (SUBLISLIS |$FormalMapVariableList|
                           |$formalArgList| |sig|))
              (setq |kindFlag|
                       (COND
                         ((BOOT-EQUAL |kind| 'CONST) 'CONST)
                         ('T NIL)))
              (setq |newSig|
                       (PROG (G166102)
                         (setq G166102 NIL)
                         (RETURN
                           (DO ((G166107 |formalSig| (CDR G166107))
                                (|x| NIL))
                               ((OR (ATOM G166107)
                                    (PROGN
                                      (SETQ |x| (CAR G166107))
                                      NIL))
                                (NREVERSE0 G166102))
                             (SEQ (EXIT (SETQ G166102
                                         (CONS
                                          (OR (|NRTassocIndex| |x|)
                                           |x|)
                                          G166102))))))))
              (CONS |newSig| (CONS |dcCode| (CONS |op| |kindFlag|)))))))))

;--NRTencodeSig x == [NRTencode y for y in x]
;NRTreplaceAllLocalReferences(form) ==
;  $devaluateList :local := []
;  NRTputInLocalReferences form

(DEFUN |NRTreplaceAllLocalReferences| (|form|)
  (PROG (|$devaluateList|)
    (DECLARE (SPECIAL |$devaluateList|))
    (RETURN
      (PROGN
        (setq |$devaluateList| NIL)
        (|NRTputInLocalReferences| |form|)))))

;NRTencode(x,y) == encode(x,y,true) where encode(x,compForm,firstTime) ==
;  --converts a domain form to a lazy domain form; everything other than
;  --the operation name should be assigned a slot
;  null firstTime and (k:= NRTassocIndex x) => k
;  VECP x => systemErrorHere '"NRTencode"
;  CONSP x =>
;    QCAR x='Record or x is ['Union,['_:,a,b],:.] =>
;      [QCAR x,:[['_:,a,encode(b,c,false)]
;        for [.,a,b] in QCDR x for [.,=a,c] in CDR compForm]]
;    constructor? QCAR x or MEMQ(QCAR x,'(Union Mapping)) =>
;      [QCAR x,:[encode(y,z,false) for y in QCDR x for z in CDR compForm]]
;    ['NRTEVAL,NRTreplaceAllLocalReferences COPY_-TREE lispize compForm]
;  MEMQ(x,$formalArgList) =>
;    v := $FormalMapVariableList.(POSN1(x,$formalArgList))
;    firstTime => ['local,v]
;    v
;  x = '$ => x
;  x = "$$" => x
;  ['QUOTE,x]

(DEFUN |NRTencode,encode| (|x| |compForm| |firstTime|)
  (PROG (|k| |ISTMP#1| |ISTMP#2| |ISTMP#3| |ISTMP#4| |a| |b| |c| |v|)
  (declare (special |$formalArgList| |$FormalMapVariableList|))
    (RETURN
      (SEQ (IF (AND (NULL |firstTime|)
                    (setq |k| (|NRTassocIndex| |x|)))
               (EXIT |k|))
           (IF (VECP |x|)
               (EXIT (|systemErrorHere| "NRTencode")))
           (IF (CONSP |x|)
               (EXIT (SEQ (IF (OR (BOOT-EQUAL (QCAR |x|) '|Record|)
                                  (AND (CONSP |x|)
                                       (EQ (QCAR |x|) '|Union|)
                                       (PROGN
                                         (setq |ISTMP#1| (QCDR |x|))
                                         (AND (CONSP |ISTMP#1|)
                                          (PROGN
                                            (setq |ISTMP#2|
                                             (QCAR |ISTMP#1|))
                                            (AND (CONSP |ISTMP#2|)
                                             (EQ (QCAR |ISTMP#2|) '|:|)
                                             (PROGN
                                               (setq |ISTMP#3|
                                                (QCDR |ISTMP#2|))
                                               (AND (CONSP |ISTMP#3|)
                                                (PROGN
                                                  (setq |a|
                                                   (QCAR |ISTMP#3|))
                                                  (setq |ISTMP#4|
                                                   (QCDR |ISTMP#3|))
                                                  (AND
                                                   (CONSP |ISTMP#4|)
                                                   (EQ (QCDR |ISTMP#4|)
                                                    NIL)
                                                   (PROGN
                                                     (setq |b|
                                                      (QCAR |ISTMP#4|))
                                                     'T)))))))))))
                              (EXIT (CONS (QCAR |x|)
                                     (PROG (G166191)
                                       (setq G166191 NIL)
                                       (RETURN
                                         (DO
                                          ((G166199 (QCDR |x|)
                                            (CDR G166199))
                                           (G166173 NIL)
                                           (G166200 (CDR |compForm|)
                                            (CDR G166200))
                                           (G166177 NIL))
                                          ((OR (ATOM G166199)
                                            (PROGN
                                              (SETQ G166173
                                               (CAR G166199))
                                              NIL)
                                            (PROGN
                                              (PROGN
                                                (setq |a|
                                                 (CADR G166173))
                                                (setq |b|
                                                 (CADDR G166173))
                                                G166173)
                                              NIL)
                                            (ATOM G166200)
                                            (PROGN
                                              (SETQ G166177
                                               (CAR G166200))
                                              NIL)
                                            (PROGN
                                              (PROGN
                                                (COND
                                                  ((EQUAL |a|
                                                    (CADR G166177))
                                                   |a|))
                                                (setq |c|
                                                 (CADDR G166177))
                                                G166177)
                                              NIL))
                                           (NREVERSE0 G166191))
                                           (SEQ
                                            (EXIT
                                             (SETQ G166191
                                              (CONS
                                               (CONS '|:|
                                                (CONS |a|
                                                 (CONS
                                                  (|NRTencode,encode|
                                                   |b| |c| NIL)
                                                  NIL)))
                                               G166191))))))))))
                          (IF (OR (|constructor?| (QCAR |x|))
                                  (member (QCAR |x|)
                                        '(|Union| |Mapping|)))
                              (EXIT (CONS (QCAR |x|)
                                     (PROG (G166216)
                                       (setq G166216 NIL)
                                       (RETURN
                                         (DO
                                          ((G166222 (QCDR |x|)
                                            (CDR G166222))
                                           (|y| NIL)
                                           (G166223 (CDR |compForm|)
                                            (CDR G166223))
                                           (|z| NIL))
                                          ((OR (ATOM G166222)
                                            (PROGN
                                              (SETQ |y|
                                               (CAR G166222))
                                              NIL)
                                            (ATOM G166223)
                                            (PROGN
                                              (SETQ |z|
                                               (CAR G166223))
                                              NIL))
                                           (NREVERSE0 G166216))
                                           (SEQ
                                            (EXIT
                                             (SETQ G166216
                                              (CONS
                                               (|NRTencode,encode| |y|
                                                |z| NIL)
                                               G166216))))))))))
                          (EXIT (CONS 'NRTEVAL
                                      (CONS
                                       (|NRTreplaceAllLocalReferences|
                                        (COPY-TREE
                                         (|lispize| |compForm|)))
                                       NIL))))))
           (IF (member |x| |$formalArgList|)
               (EXIT (SEQ (setq |v|
                                   (ELT |$FormalMapVariableList|
                                    (POSN1 |x| |$formalArgList|)))
                          (IF |firstTime|
                              (EXIT (CONS '|local| (CONS |v| NIL))))
                          (EXIT |v|))))
           (IF (BOOT-EQUAL |x| '$) (EXIT |x|))
           (IF (BOOT-EQUAL |x| '$$) (EXIT |x|))
           (EXIT (CONS 'QUOTE (CONS |x| NIL)))))))


(DEFUN |NRTencode| (|x| |y|) (|NRTencode,encode| |x| |y| 'T))

;--------------FUNCTIONS CALLED DURING CAPSULE FUNCTION COMPILATION-------------
;listOfBoundVars form ==
;-- Only called from the function genDeltaEntry below
;  form = '$ => []
;  IDENTP form and (u:=get(form,'value,$e)) =>
;    u:=u.expr
;    MEMQ(KAR u,'(Union Record)) => listOfBoundVars u
;    [form]
;  atom form => []
;  CAR form = 'QUOTE => []
;  EQ(CAR form,":") => listOfBoundVars CADDR form
;  -- We don't want to pick up the tag, only the domain
;  "UNION"/[listOfBoundVars x for x in CDR form]

(DEFUN |listOfBoundVars| (|form|)
  (PROG (|u|)
  (declare (special |$e|))
    (RETURN
      (SEQ (COND
             ((BOOT-EQUAL |form| '$) NIL)
             ((AND (IDENTP |form|)
                   (setq |u| (|get| |form| '|value| |$e|)))
              (setq |u| (CAR |u|))
              (COND
                ((member (ifcar |u|) '(|Union| |Record|))
                 (|listOfBoundVars| |u|))
                ('T (CONS |form| NIL))))
             ((ATOM |form|) NIL)
             ((BOOT-EQUAL (CAR |form|) 'QUOTE) NIL)
             ((EQ (CAR |form|) '|:|)
              (|listOfBoundVars| (CADDR |form|)))
             ('T
              (PROG (G166254)
                (setq G166254 NIL)
                (RETURN
                  (DO ((G166259 (CDR |form|) (CDR G166259))
                       (|x| NIL))
                      ((OR (ATOM G166259)
                           (PROGN (SETQ |x| (CAR G166259)) NIL))
                       G166254)
                    (SEQ (EXIT (SETQ G166254
                                     (|union| G166254
                                      (|listOfBoundVars| |x|))))))))))))))

;optDeltaEntry(op,sig,dc,eltOrConst) ==
;  $killOptimizeIfTrue = true => nil
;  ndc :=
;    dc = '$ => $functorForm
;    atom dc and (dcval := get(dc,'value,$e)) => dcval.expr
;    dc
;--if (atom dc) and (dcval := get(dc,'value,$e))
;--   then ndc := dcval.expr
;--   else ndc := dc
;  sig := SUBST(ndc,dc,sig)
;  not MEMQ(KAR ndc,$optimizableConstructorNames) => nil
;  dcval := optCallEval ndc
;  -- MSUBST guarantees to use EQUAL testing
;  sig := MSUBST(devaluate dcval, ndc, sig)
;  if rest ndc then
;     for new in rest devaluate dcval for old in rest ndc repeat
;       sig := MSUBST(new,old,sig)
;     -- optCallEval sends (List X) to (LIst (Integer)) etc,
;     -- so we should make the same transformation
;  fn := compiledLookup(op,sig,dcval)
;  if null fn then
;    -- following code is to handle selectors like first, rest
;     nsig := [quoteSelector tt for tt in sig] where
;       quoteSelector(x) ==
;         not(IDENTP x) => x
;         get(x,'value,$e) => x
;         x='$ => x
;         MKQ x
;     fn := compiledLookup(op,nsig,dcval)
;     if null fn then return nil
;  eltOrConst="CONST" => ['XLAM,'ignore,MKQ SPADCALL fn]
;  GET(compileTimeBindingOf first fn,'SPADreplace)

(DEFUN |optDeltaEntry,quoteSelector| (|x|)
  (declare (special |$e|))
  (SEQ (IF (NULL (IDENTP |x|)) (EXIT |x|))
       (IF (|get| |x| '|value| |$e|) (EXIT |x|))
       (IF (BOOT-EQUAL |x| '$) (EXIT |x|)) (EXIT (MKQ |x|))))

(DEFUN |optDeltaEntry| (|op| |sig| |dc| |eltOrConst|)
  (PROG (|ndc| |dcval| |nsig| |fn|)
  (declare (special |$optimizableConstructorNames| |$e| |$functorForm|
                    |$killOptimizeIfTrue|))
    (RETURN
      (SEQ (COND
             ((BOOT-EQUAL |$killOptimizeIfTrue| 'T) NIL)
             ('T
              (setq |ndc|
                       (COND
                         ((BOOT-EQUAL |dc| '$) |$functorForm|)
                         ((AND (ATOM |dc|)
                               (setq |dcval|
                                        (|get| |dc| '|value| |$e|)))
                          (CAR |dcval|))
                         ('T |dc|)))
              (setq |sig| (MSUBST |ndc| |dc| |sig|))
              (COND
                ((NULL (member (ifcar |ndc|)
                             |$optimizableConstructorNames|))
                 NIL)
                ('T (setq |dcval| (|optCallEval| |ndc|))
                 (setq |sig|
                          (MSUBST (|devaluate| |dcval|) |ndc| |sig|))
                 (COND
                   ((CDR |ndc|)
                    (DO ((G166283 (CDR (|devaluate| |dcval|))
                             (CDR G166283))
                         (|new| NIL)
                         (G166284 (CDR |ndc|) (CDR G166284))
                         (|old| NIL))
                        ((OR (ATOM G166283)
                             (PROGN (SETQ |new| (CAR G166283)) NIL)
                             (ATOM G166284)
                             (PROGN (SETQ |old| (CAR G166284)) NIL))
                         NIL)
                      (SEQ (EXIT (setq |sig|
                                          (MSUBST |new| |old| |sig|)))))))
                 (setq |fn| (|compiledLookup| |op| |sig| |dcval|))
                 (COND
                   ((NULL |fn|)
                    (setq |nsig|
                             (PROG (G166297)
                               (setq G166297 NIL)
                               (RETURN
                                 (DO ((G166302 |sig| (CDR G166302))
                                      (|tt| NIL))
                                     ((OR (ATOM G166302)
                                       (PROGN
                                         (SETQ |tt| (CAR G166302))
                                         NIL))
                                      (NREVERSE0 G166297))
                                   (SEQ
                                    (EXIT
                                     (SETQ G166297
                                      (CONS
                                       (|optDeltaEntry,quoteSelector|
                                        |tt|)
                                       G166297))))))))
                    (setq |fn|
                             (|compiledLookup| |op| |nsig| |dcval|))
                    (COND ((NULL |fn|) (RETURN NIL)) ('T NIL))))
                 (COND
                   ((BOOT-EQUAL |eltOrConst| 'CONST)
                    (CONS 'XLAM
                          (CONS '|ignore|
                                (CONS (MKQ (SPADCALL |fn|)) NIL))))
                   ('T
                    (GETL (|compileTimeBindingOf| (CAR |fn|))
                          '|SPADreplace|)))))))))))

;genDeltaEntry opMmPair ==
;--called from compApplyModemap
;--$NRTdeltaLength=0.. always equals length of $NRTdeltaList
;  [.,[odc,:.],.] := opMmPair
;  --opModemapPair := SUBLIS($LocalDomainAlist,opMmPair)
;  [op,[dc,:sig],[.,cform:=[eltOrConst,.,nsig]]] := opMmPair
;  if $profileCompiler = true then profileRecord(dc,op,sig)
;  eltOrConst = 'XLAM => cform
;  if eltOrConst = 'Subsumed then eltOrConst := 'ELT
;  if atom dc then
;    dc = "$" => nsig := sig
;    if NUMBERP nsig then nsig := substitute('$,dc,substitute("$$","$",sig))
;    -- following hack needed to invert Rep to $ substitution
;--  if odc = 'Rep and cform is [.,.,osig] then sig:=osig
;  newimp := optDeltaEntry(op,nsig,dc,eltOrConst) => newimp
;  setDifference(listOfBoundVars dc,$functorLocalParameters) ^= [] =>
;    ['applyFun,['compiledLookupCheck,MKQ op,
;         mkList consSig(nsig,dc),consDomainForm(dc,nil)]]
;  odc := dc
;  if null atom dc then dc := substitute("$$",'$,dc)
; --   sig := substitute('$,dc,sig)
; --   cform := substitute('$,dc,cform)
;  opModemapPair :=
;    [op,[dc,:[genDeltaSig x for x in nsig]],['T,cform]] -- force pred to T
;  if null NRTassocIndex dc and dc ^= $NRTaddForm and
;    (MEMBER(dc,$functorLocalParameters) or null atom dc) then
;    --create "domain" entry to $NRTdeltaList
;      $NRTdeltaList:= [['domain,NRTaddInner dc,:dc],:$NRTdeltaList]
;      saveNRTdeltaListComp:= $NRTdeltaListComp:=[nil,:$NRTdeltaListComp]
;      $NRTdeltaLength := $NRTdeltaLength+1
;      compEntry:= compOrCroak(odc,$EmptyMode,$e).expr
;--      dc
;      RPLACA(saveNRTdeltaListComp,compEntry)
;  u :=
;    [eltOrConst,'$,$NRTbase+$NRTdeltaLength-index] where index ==
;      (n:= POSN1(opModemapPair,$NRTdeltaList)) => n + 1
;        --n + 1 since $NRTdeltaLength is 1 too large
;      $NRTdeltaList:= [opModemapPair,:$NRTdeltaList]
;      $NRTdeltaListComp:=[nil,:$NRTdeltaListComp]
;      $NRTdeltaLength := $NRTdeltaLength+1
;      0
;  u

(DEFUN |genDeltaEntry| (|opMmPair|)
  (PROG (|op| |sig| |cform| |eltOrConst| |nsig| |newimp| |odc| |dc|
              |opModemapPair| |saveNRTdeltaListComp| |compEntry| |n| |u|)
  (declare (special |$NRTdeltaLength| |$NRTdeltaListComp| |$NRTdeltaList|
                    |$NRTbase| |$e| |$EmptyMode| |$functorLocalParameters|
                    |$NRTaddForm| |$profileCompiler|))
    (RETURN
      (SEQ (PROGN
             (setq |odc| (CAADR |opMmPair|))
             (setq |op| (CAR |opMmPair|))
             (setq |dc| (CAADR |opMmPair|))
             (setq |sig| (CDADR |opMmPair|))
             (setq |cform| (CAR (CDADDR |opMmPair|)))
             (setq |eltOrConst| (CAAR (CDADDR |opMmPair|)))
             (setq |nsig| (CADDAR (CDADDR |opMmPair|)))
             (COND
               ((BOOT-EQUAL |$profileCompiler| 'T)
                (|profileRecord| |dc| |op| |sig|)))
             (COND
               ((BOOT-EQUAL |eltOrConst| 'XLAM) |cform|)
               ('T
                (COND
                  ((BOOT-EQUAL |eltOrConst| '|Subsumed|)
                   (setq |eltOrConst| 'ELT)))
                (COND
                  ((ATOM |dc|)
                   (COND
                     ((BOOT-EQUAL |dc| '$) (setq |nsig| |sig|))
                     ((NUMBERP |nsig|)
                      (setq |nsig|
                               (MSUBST '$ |dc| (MSUBST '$$ '$ |sig|))))
                     ('T NIL))))
                (COND
                  ((setq |newimp|
                            (|optDeltaEntry| |op| |nsig| |dc|
                                |eltOrConst|))
                   |newimp|)
                  ((NEQUAL (SETDIFFERENCE (|listOfBoundVars| |dc|)
                               |$functorLocalParameters|)
                           NIL)
                   (CONS '|applyFun|
                         (CONS (CONS '|compiledLookupCheck|
                                     (CONS (MKQ |op|)
                                      (CONS
                                       (|mkList|
                                        (|consSig| |nsig| |dc|))
                                       (CONS
                                        (|consDomainForm| |dc| NIL)
                                        NIL))))
                               NIL)))
                  ('T (setq |odc| |dc|)
                   (COND
                     ((NULL (ATOM |dc|))
                      (setq |dc| (MSUBST '$$ '$ |dc|))))
                   (setq |opModemapPair|
                            (CONS |op|
                                  (CONS (CONS |dc|
                                         (PROG (G166339)
                                           (setq G166339 NIL)
                                           (RETURN
                                             (DO
                                              ((G166344 |nsig|
                                                (CDR G166344))
                                               (|x| NIL))
                                              ((OR (ATOM G166344)
                                                (PROGN
                                                  (SETQ |x|
                                                   (CAR G166344))
                                                  NIL))
                                               (NREVERSE0 G166339))
                                               (SEQ
                                                (EXIT
                                                 (SETQ G166339
                                                  (CONS
                                                   (|genDeltaSig| |x|)
                                                   G166339))))))))
                                        (CONS
                                         (CONS 'T (CONS |cform| NIL))
                                         NIL))))
                   (COND
                     ((AND (NULL (|NRTassocIndex| |dc|))
                           (NEQUAL |dc| |$NRTaddForm|)
                           (OR (|member| |dc| |$functorLocalParameters|)
                               (NULL (ATOM |dc|))))
                      (setq |$NRTdeltaList|
                               (CONS (CONS '|domain|
                                      (CONS (|NRTaddInner| |dc|) |dc|))
                                     |$NRTdeltaList|))
                      (setq |saveNRTdeltaListComp|
                               (setq |$NRTdeltaListComp|
                                        (CONS NIL |$NRTdeltaListComp|)))
                      (setq |$NRTdeltaLength|
                               (+ |$NRTdeltaLength| 1))
                      (setq |compEntry|
                               (CAR (|compOrCroak| |odc| |$EmptyMode|
                                     |$e|)))
                      (RPLACA |saveNRTdeltaListComp| |compEntry|)))
                   (setq |u|
                            (CONS |eltOrConst|
                                  (CONS '$
                                        (CONS
                                         (-
                                          (+ |$NRTbase|
                                           |$NRTdeltaLength|)
                                          (COND
                                            ((setq |n|
                                              (POSN1 |opModemapPair|
                                               |$NRTdeltaList|))
                                             (+ |n| 1))
                                            ('T
                                             (setq |$NRTdeltaList|
                                              (CONS |opModemapPair|
                                               |$NRTdeltaList|))
                                             (setq
                                              |$NRTdeltaListComp|
                                              (CONS NIL
                                               |$NRTdeltaListComp|))
                                             (setq |$NRTdeltaLength|
                                              (+ |$NRTdeltaLength|
                                               1))
                                             0)))
                                         NIL))))
                   |u|)))))))))

;genDeltaSig x ==
;  NRTgetLocalIndex x

(DEFUN |genDeltaSig| (|x|) (|NRTgetLocalIndex| |x|))

;genDeltaSpecialSig x ==
;  x is [":",y,z] => [":",y,genDeltaSig z]
;  genDeltaSig x

(DEFUN |genDeltaSpecialSig| (|x|)
  (PROG (|ISTMP#1| |y| |ISTMP#2| |z|)
    (RETURN
      (COND
        ((AND (CONSP |x|) (EQ (QCAR |x|) '|:|)
              (PROGN
                (setq |ISTMP#1| (QCDR |x|))
                (AND (CONSP |ISTMP#1|)
                     (PROGN
                       (setq |y| (QCAR |ISTMP#1|))
                       (setq |ISTMP#2| (QCDR |ISTMP#1|))
                       (AND (CONSP |ISTMP#2|) (EQ (QCDR |ISTMP#2|) NIL)
                            (PROGN (setq |z| (QCAR |ISTMP#2|)) 'T))))))
         (CONS '|:| (CONS |y| (CONS (|genDeltaSig| |z|) NIL))))
        ('T (|genDeltaSig| |x|))))))

;NRTassocIndexAdd x ==
;  x = $NRTaddForm => 5
;  NRTassocIndex x

(DEFUN |NRTassocIndexAdd| (|x|)
  (declare (special |$NRTaddForm|))
  (COND ((BOOT-EQUAL |x| |$NRTaddForm|) 5) ('T (|NRTassocIndex| |x|))))


;NRTgetAddForm domain ==
;  u := HGET($Slot1DataBase,first domain) =>
;    EQSUBSTLIST(rest domain,$FormalMapVariableList,first u)
;  systemErrorHere '"NRTgetAddForm"

(DEFUN |NRTgetAddForm| (|domain|)
  (PROG (|u|)
  (declare (special |$FormalMapVariableList| |$Slot1DataBase|))
    (RETURN
      (COND
        ((setq |u| (HGET |$Slot1DataBase| (CAR |domain|)))
         (EQSUBSTLIST (CDR |domain|) |$FormalMapVariableList|
             (CAR |u|)))
        ('T (|systemErrorHere| "NRTgetAddForm"))))))

;NRTassignCapsuleFunctionSlot(op,sig) ==
;--called from compDefineCapsuleFunction
;  opSig := [op,sig]
;  [.,.,implementation] := NRTisExported? opSig or return nil
;    --if opSig is not exported, it is local and need not be assigned
;  if $insideCategoryPackageIfTrue then
;      sig := substitute('$,CADR($functorForm),sig)
;  sig := [genDeltaSig x for x in sig]
;  opModemapPair := [op,['_$,:sig],['T,implementation]]
;  POSN1(opModemapPair,$NRTdeltaList) => nil   --already there
;  $NRTdeltaList:= [opModemapPair,:$NRTdeltaList]
;  $NRTdeltaListComp := [nil,:$NRTdeltaListComp]
;  $NRTdeltaLength := $NRTdeltaLength+1

(DEFUN |NRTassignCapsuleFunctionSlot| (|op| |sig|)
  (PROG (|opSig| |LETTMP#1| |implementation| |opModemapPair|)
  (declare (special |$NRTdeltaLength| |$NRTdeltaListComp| |$NRTdeltaList|
                    |$functorForm| |$insideCategoryPackageIfTrue|))
    (RETURN
      (SEQ (PROGN
             (setq |opSig| (CONS |op| (CONS |sig| NIL)))
             (setq |LETTMP#1|
                      (OR (|NRTisExported?| |opSig|) (RETURN NIL)))
             (setq |implementation| (CADDR |LETTMP#1|))
             (COND
               (|$insideCategoryPackageIfTrue|
                   (setq |sig|
                            (MSUBST '$ (CADR |$functorForm|) |sig|))))
             (setq |sig|
                      (PROG (G166470)
                        (setq G166470 NIL)
                        (RETURN
                          (DO ((G166475 |sig| (CDR G166475))
                               (|x| NIL))
                              ((OR (ATOM G166475)
                                   (PROGN
                                     (SETQ |x| (CAR G166475))
                                     NIL))
                               (NREVERSE0 G166470))
                            (SEQ (EXIT (SETQ G166470
                                        (CONS (|genDeltaSig| |x|)
                                         G166470))))))))
             (setq |opModemapPair|
                      (CONS |op|
                            (CONS (CONS '$ |sig|)
                                  (CONS (CONS 'T
                                         (CONS |implementation| NIL))
                                        NIL))))
             (COND
               ((POSN1 |opModemapPair| |$NRTdeltaList|) NIL)
               ('T
                (setq |$NRTdeltaList|
                         (CONS |opModemapPair| |$NRTdeltaList|))
                (setq |$NRTdeltaListComp|
                         (CONS NIL |$NRTdeltaListComp|))
                (setq |$NRTdeltaLength| (+ |$NRTdeltaLength| 1)))))))))

;NRTisExported? opSig ==
;  or/[u for u in $domainShell.1 | u.0 = opSig]

(DEFUN |NRTisExported?| (|opSig|)
  (PROG ()
  (declare (special |$domainShell|))
    (RETURN
      (SEQ (PROG (G166494)
             (setq G166494 NIL)
             (RETURN
               (DO ((G166501 NIL G166494)
                    (G166502 (ELT |$domainShell| 1) (CDR G166502))
                    (|u| NIL))
                   ((OR G166501 (ATOM G166502)
                        (PROGN (SETQ |u| (CAR G166502)) NIL))
                    G166494)
                 (SEQ (EXIT (COND
                              ((BOOT-EQUAL (ELT |u| 0) |opSig|)
                               (SETQ G166494 (OR G166494 |u|)))))))))))))

;consOpSig(op,sig,dc) ==
;  if null atom op then
;    keyedSystemError("S2GE0016",['"consOpSig",'"bad operator in table"])
;  mkList [MKQ op,mkList consSig(sig,dc)]

(DEFUN |consOpSig| (|op| |sig| |dc|)
  (PROGN
    (COND
      ((NULL (ATOM |op|))
       (|keyedSystemError|
        "Unexpected error or improper call to system function %1: %2"
           (CONS "consOpSig"
                 (CONS "bad operator in table" NIL)))))
    (|mkList|
        (CONS (MKQ |op|) (CONS (|mkList| (|consSig| |sig| |dc|)) NIL)))))

;consSig(sig,dc) == [consDomainName(sigpart,dc) for sigpart in sig]

(DEFUN |consSig| (|sig| |dc|)
  (PROG ()
    (RETURN
      (SEQ (PROG (G166521)
             (setq G166521 NIL)
             (RETURN
               (DO ((G166526 |sig| (CDR G166526)) (|sigpart| NIL))
                   ((OR (ATOM G166526)
                        (PROGN (SETQ |sigpart| (CAR G166526)) NIL))
                    (NREVERSE0 G166521))
                 (SEQ (EXIT (SETQ G166521
                                  (CONS (|consDomainName| |sigpart|
                                         |dc|)
                                        G166521)))))))))))

;consDomainName(x,dc) ==
;  x = dc => ''$
;  x = '$ => ''$
;  x = "$$" => ['devaluate,'$]
;  x is [op,:argl] =>
;    (op = 'Record) or (op = 'Union and argl is [[":",:.],:.])  =>
;       mkList [MKQ op,
;         :[['LIST,MKQ '_:,MKQ tag,consDomainName(dom,dc)]
;                   for [.,tag,dom] in argl]]
;    isFunctor op or op = 'Mapping or constructor? op =>
;         -- call to constructor? needed if op was compiled in $bootStrapMode
;        mkList [MKQ op,:[consDomainName(y,dc) for y in argl]]
;    substitute('$,"$$",x)
;  x = [] => x
;  (y := LASSOC(x,$devaluateList)) => y
;  k:=NRTassocIndex x =>
;    ['devaluate,['ELT,'$,k]]
;  get(x,'value,$e) =>
;    isDomainForm(x,$e) => ['devaluate,x]
;    x
;  MKQ x

(DEFUN |consDomainName| (|x| |dc|)
  (PROG (|op| |argl| |ISTMP#1| |tag| |dom| |y| |k|)
  (declare (special |$e| |$devaluateList|))
    (RETURN
      (SEQ (COND
             ((BOOT-EQUAL |x| |dc|) ''$)
             ((BOOT-EQUAL |x| '$) ''$)
             ((BOOT-EQUAL |x| '$$) (CONS '|devaluate| (CONS '$ NIL)))
             ((AND (CONSP |x|)
                   (PROGN
                     (setq |op| (QCAR |x|))
                     (setq |argl| (QCDR |x|))
                     'T))
              (COND
                ((OR (BOOT-EQUAL |op| '|Record|)
                     (AND (BOOT-EQUAL |op| '|Union|) (CONSP |argl|)
                          (PROGN
                            (setq |ISTMP#1| (QCAR |argl|))
                            (AND (CONSP |ISTMP#1|)
                                 (EQ (QCAR |ISTMP#1|) '|:|)))))
                 (|mkList|
                     (CONS (MKQ |op|)
                           (PROG (G166553)
                             (setq G166553 NIL)
                             (RETURN
                               (DO ((G166559 |argl| (CDR G166559))
                                    (G166541 NIL))
                                   ((OR (ATOM G166559)
                                     (PROGN
                                       (SETQ G166541 (CAR G166559))
                                       NIL)
                                     (PROGN
                                       (PROGN
                                         (setq |tag|
                                          (CADR G166541))
                                         (setq |dom|
                                          (CADDR G166541))
                                         G166541)
                                       NIL))
                                    (NREVERSE0 G166553))
                                 (SEQ (EXIT
                                       (SETQ G166553
                                        (CONS
                                         (CONS 'LIST
                                          (CONS (MKQ '|:|)
                                           (CONS (MKQ |tag|)
                                            (CONS
                                             (|consDomainName| |dom|
                                              |dc|)
                                             NIL))))
                                         G166553))))))))))
                ((OR (|isFunctor| |op|) (BOOT-EQUAL |op| '|Mapping|)
                     (|constructor?| |op|))
                 (|mkList|
                     (CONS (MKQ |op|)
                           (PROG (G166570)
                             (setq G166570 NIL)
                             (RETURN
                               (DO ((G166575 |argl| (CDR G166575))
                                    (|y| NIL))
                                   ((OR (ATOM G166575)
                                     (PROGN
                                       (SETQ |y| (CAR G166575))
                                       NIL))
                                    (NREVERSE0 G166570))
                                 (SEQ (EXIT
                                       (SETQ G166570
                                        (CONS
                                         (|consDomainName| |y| |dc|)
                                         G166570))))))))))
                ('T (MSUBST '$ '$$ |x|))))
             ((NULL |x|) |x|)
             ((setq |y| (LASSOC |x| |$devaluateList|)) |y|)
             ((setq |k| (|NRTassocIndex| |x|))
              (CONS '|devaluate|
                    (CONS (CONS 'ELT (CONS '$ (CONS |k| NIL))) NIL)))
             ((|get| |x| '|value| |$e|)
              (COND
                ((|isDomainForm| |x| |$e|)
                 (CONS '|devaluate| (CONS |x| NIL)))
                ('T |x|)))
             ('T (MKQ |x|)))))))

;consDomainForm(x,dc) ==
;  x = '$ => '$
;  x is [op,:argl] =>
;     op = ":" and argl is [tag, value] => [op, tag, consDomainForm(value,dc)]
;     [op,:[consDomainForm(y,dc) for y in argl]]
;  x = [] => x
;  (y := LASSOC(x,$devaluateList)) => y
;  k:=NRTassocIndex x => ['ELT,'$,k]
;  get(x,'value,$e) or get(x,'mode,$e) => x
;  MKQ x

(DEFUN |consDomainForm| (|x| |dc|)
  (PROG (|op| |argl| |tag| |ISTMP#1| |value| |y| |k|)
  (declare (special |$e| |$devaluateList|))
    (RETURN
      (SEQ (COND
             ((BOOT-EQUAL |x| '$) '$)
             ((AND (CONSP |x|)
                   (PROGN
                     (setq |op| (QCAR |x|))
                     (setq |argl| (QCDR |x|))
                     'T))
              (COND
                ((AND (BOOT-EQUAL |op| '|:|) (CONSP |argl|)
                      (PROGN
                        (setq |tag| (QCAR |argl|))
                        (setq |ISTMP#1| (QCDR |argl|))
                        (AND (CONSP |ISTMP#1|)
                             (EQ (QCDR |ISTMP#1|) NIL)
                             (PROGN
                               (setq |value| (QCAR |ISTMP#1|))
                               'T))))
                 (CONS |op|
                       (CONS |tag|
                             (CONS (|consDomainForm| |value| |dc|) NIL))))
                ('T
                 (CONS |op|
                       (PROG (G166611)
                         (setq G166611 NIL)
                         (RETURN
                           (DO ((G166616 |argl| (CDR G166616))
                                (|y| NIL))
                               ((OR (ATOM G166616)
                                    (PROGN
                                      (SETQ |y| (CAR G166616))
                                      NIL))
                                (NREVERSE0 G166611))
                             (SEQ (EXIT (SETQ G166611
                                         (CONS
                                          (|consDomainForm| |y| |dc|)
                                          G166611)))))))))))
             ((NULL |x|) |x|)
             ((setq |y| (LASSOC |x| |$devaluateList|)) |y|)
             ((setq |k| (|NRTassocIndex| |x|))
              (CONS 'ELT (CONS '$ (CONS |k| NIL))))
             ((OR (|get| |x| '|value| |$e|) (|get| |x| '|mode| |$e|))
              |x|)
             ('T (MKQ |x|)))))))

;buildFunctor($definition is [name,:args],sig,code,$locals,$e) ==
;--PARAMETERS
;--  $definition: constructor form, e.g. (SquareMatrix 10 (RationalNumber))
;--  sig: signature of constructor form
;--  code: result of "doIt", converting body of capsule to CodeDefine forms, e.g.
;--       (PROGN (LET Rep ...)
;--              (: (ListOf x y) $)
;--              (CodeDefine (<op> <signature> <functionName>))
;--              (COND ((HasCategory $ ...) (PROGN ...))) ..)
;--  $locals: list of variables to go into slot 5, e.g. (R Rep R,1 R,2 R,3 R,4)
;--           same as $functorLocalParameters
;--           this list is not augmented by this function
;--  $e: environment
;--GLOBAL VARIABLES REFERENCED:
;--  $domainShell: passed in from compDefineFunctor1
;--  $QuickCode: compilation flag
;  if code is ['add,.,newstuff] then code := newstuff
;  changeDirectoryInSlot1()  --this extends $NRTslot1PredicateList
;  --pp '"=================="
;  --for item in $NRTdeltaList repeat pp item
;--LOCAL BOUND FLUID VARIABLES:
;  $GENNO: local:= 0     --bound in compDefineFunctor1, then as parameter here
;--$frontier: local      --index of first local slot=#(cat part of princ view)
;  $catvecList: local    --list of vectors v1..vn for each view
;  $hasCategoryAlist: local  --list of GENSYMs bound to (HasCategory ..) items
;  $catNames: local      --list of names n1..nn for each view
;  $maximalViews: local  --list of maximal categories for domain (???)
;  $catsig: local        --target category (used in ProcessCond)
;  $SetFunctions: local  --copy of p view with preds telling when fnct defined
;  $MissingFunctionInfo: local --now useless
;     --vector marking which functions are assigned
;  $ConstantAssignments: local --code for creation of constants
;  $epilogue: local := nil     --code to set slot 5, things to be done last
;  $HackSlot4: local  --Invention of JHD 13/July/86-set in InvestigateConditions
;  $extraParms:local  --Set in DomainSubstitutionFunction, used in setVector12
;  $devaluateList: local --Bound to ((#1 . dv$1)..) where &1 := devaluate #1 later
;  $devaluateList:= [[arg,:b] for arg in args for b in $ModeVariableList]
;  $supplementaries: local := nil
;   --set in InvestigateConditions to represent any additional
;   --category membership tests that may be needed(see buildFunctor for details)
;------------------------
;  $maximalViews: local := nil
;  oldtime:= TEMPUS_-FUGIT()
;  [$catsig,:argsig]:= sig
;  catvecListMaker:=REMDUP
;    [(comp($catsig,$EmptyMode,$e)).expr,
;      :[compCategories first u for u in CADR $domainShell.4]]
;  condCats:= InvestigateConditions [$catsig,:rest catvecListMaker]
;  -- a list, one %for each element of catvecListMaker
;  -- indicating under what conditions this
;  -- category should be present.  true => always
;  makeCatvecCode:= first catvecListMaker
;  emptyVector := VECTOR()
;--if $NRTaddForm and null NRTassocIndex $NRTaddForm then
;--  --create "domain" entry to $NRTdeltaList
;--    $NRTdeltaList:=
;--      [['domain,NRTaddInner $NRTaddForm,:$NRTaddForm],:$NRTdeltaList]
;--    $NRTdeltaLength := $NRTdeltaLength+1
;--NRTgetLocalIndex $NRTaddForm
;  domainShell := GETREFV (6 + $NRTdeltaLength)
;  for i in 0..4 repeat domainShell.i := $domainShell.i
;    --we will clobber elements; copy since $domainShell may be a cached vector
;  $template :=
;    $NRTvec = true => GETREFV (6 + $NRTdeltaLength)
;    nil
;  $catvecList:= [domainShell,:[emptyVector for u in CADR domainShell.4]]
;  $catNames := ['$] -- for DescendCode -- to be changed below for slot 4
;  $maximalViews:= nil
;  $SetFunctions:= GETREFV SIZE domainShell
;  $MissingFunctionInfo:= GETREFV SIZE domainShell
;  $catNames:= ['$,:[GENVAR() for u in rest catvecListMaker]]
;  domname:='dv_$
;-->  Do this now to create predicate vector; then DescendCode can refer
;-->  to predicate vector if it can
;  [$uncondAlist,:$condAlist] :=    --bound in compDefineFunctor1
;      NRTsetVector4Part1($catNames,catvecListMaker,condCats)
;  [$NRTslot1PredicateList,predBitVectorCode1,:predBitVectorCode2] :=
;      makePredicateBitVector [:ASSOCRIGHT $condAlist,:$NRTslot1PredicateList]
;  storeOperationCode:= DescendCode(code,true,nil,first $catNames)
;  outsideFunctionCode:= NRTaddDeltaCode()
;  storeOperationCode:= NRTputInLocalReferences storeOperationCode
;  if $NRTvec = true then
;    NRTdescendCodeTran(storeOperationCode,nil) --side effects storeOperationCode
;  codePart2:=
;    $NRTvec = true =>
;      argStuffCode :=
;        [[$setelt,'$,i,v] for i in 6.. for v in $FormalMapVariableList
;          for arg in rest $definition]
;      if MEMQ($NRTaddForm,$locals) then
;         addargname := $FormalMapVariableList.(POSN1($NRTaddForm,$locals))
;         argStuffCode := [[$setelt,'$,5,addargname],:argStuffCode]
;      [['stuffDomainSlots,'$],:argStuffCode,
;         :predBitVectorCode2,storeOperationCode]
;    [:outsideFunctionCode,storeOperationCode]
;  $CheckVectorList := NRTcheckVector domainShell
;--CODE: part 1
;  codePart1:= [:devaluateCode,:domainFormCode,createDomainCode,
;                createViewCode,setVector0Code, slot3Code,:slamCode] where
;    devaluateCode:= [['LET,b,['devaluate,a]] for [a,:b] in $devaluateList]
;    domainFormCode := [['LET,a,b] for [a,:b] in NREVERSE $NRTdomainFormList]
;      --$NRTdomainFormList is unused now
;    createDomainCode:=
;      ['LET,domname,['LIST,MKQ CAR $definition,:ASSOCRIGHT $devaluateList]]
;    createViewCode:= ['LET,'$,['GETREFV, 6+$NRTdeltaLength]]
;    setVector0Code:=[$setelt,'$,0,'dv_$]
;    slot3Code := ['QSETREFV,'$,3,['LET,'pv_$,predBitVectorCode1]]
;    slamCode:=
;      isCategoryPackageName opOf $definition => nil
;      [NRTaddToSlam($definition,'$)]
;--CODE: part 3
;  $ConstantAssignments :=
;      [NRTputInLocalReferences code for code in $ConstantAssignments]
;  codePart3:= [:constantCode1,
;                :constantCode2,:epilogue] where
;    constantCode1:=
;      name='Integer => $ConstantAssignments
;      nil
;                      -- The above line is needed to get the recursion
;                      -- Integer => FontTable => NonNegativeInteger  => Integer
;                      -- right.  Otherwise NNI has 'unset' for 0 and 1
;--  setVector4c:= setVector4part3($catNames,$catvecList)
;                      -- In particular, setVector4part3 and setVector5,
;                      -- which generate calls to local domain-instantiators,
;                      -- must come after operations are set in the vector.
;                      -- The symptoms of getting this wrong are that
;                      -- operations are not set which should be
;    constantCode2:= --matches previous test on Integer
;      name='Integer => nil
;      $ConstantAssignments
;    epilogue:= $epilogue
;  ans :=
;    ['PROGN,:optFunctorPROGN [:codePart1,:codePart2,:codePart3], '$]
;  $getDomainCode:= nil
;    --if we didn't kill this, DEFINE would insert it in the wrong place
;  ans:= minimalise ans
;  SAY ['"time taken in buildFunctor: ",TEMPUS_-FUGIT()-oldtime]
;  --sayBrightly '"------------------functor code: -------------------"
;  --pp ans
;  ans

(DEFUN |buildFunctor| (|$definition| |sig| |code| |$locals| |$e|)
  (DECLARE (SPECIAL |$definition| |$locals| |$e|))
  (PROG ($GENNO |$catvecList| |$hasCategoryAlist| |$catNames| |$catsig|
                |$SetFunctions| |$MissingFunctionInfo|
                |$ConstantAssignments| |$epilogue| |$HackSlot4|
                |$extraParms| |$devaluateList| |$supplementaries|
                |$maximalViews| |name| |args| |ISTMP#1| |ISTMP#2|
                |newstuff| |oldtime| |argsig| |catvecListMaker|
                |condCats| |makeCatvecCode| |emptyVector| |domainShell|
                |domname| |LETTMP#1| |predBitVectorCode1|
                |predBitVectorCode2| |outsideFunctionCode|
                |storeOperationCode| |addargname| |argStuffCode|
                |codePart2| |devaluateCode| |a| |b| |domainFormCode|
                |createDomainCode| |createViewCode| |setVector0Code|
                |slot3Code| |slamCode| |codePart1| |constantCode1|
                |constantCode2| |epilogue| |codePart3| |ans|)
    (DECLARE (SPECIAL $GENNO |$catvecList| |$hasCategoryAlist| |$EmptyMode|
                      |$catNames| |$catsig| |$SetFunctions| |$ModeVariableList|
                      |$MissingFunctionInfo| |$ConstantAssignments| |$setelt|
                      |$epilogue| |$HackSlot4| |$extraParms| |$NRTdeltaLength|
                      |$devaluateList| |$supplementaries| |$NRTdomainFormList|
                      |$maximalViews| |$getDomainCode| |$CheckVectorList|
                      |$NRTaddForm| |$FormalMapVariableList| |$NRTvec|
                      |$catNames| |$NRTslot1PredicateList| |$condAlist|
                      |$uncondAlist| |$template| |$domainShell| 
                      |$SetFunctions|))
    (RETURN
      (SEQ (PROGN
             (setq |name| (CAR |$definition|))
             (setq |args| (CDR |$definition|))
             (COND
               ((AND (CONSP |code|) (EQ (QCAR |code|) '|add|)
                     (PROGN
                       (setq |ISTMP#1| (QCDR |code|))
                       (AND (CONSP |ISTMP#1|)
                            (PROGN
                              (setq |ISTMP#2| (QCDR |ISTMP#1|))
                              (AND (CONSP |ISTMP#2|)
                                   (EQ (QCDR |ISTMP#2|) NIL)
                                   (PROGN
                                     (setq |newstuff|
                                      (QCAR |ISTMP#2|))
                                     'T))))))
                (setq |code| |newstuff|)))
             (|changeDirectoryInSlot1|)
             (setq $GENNO 0)
             (setq |$catvecList| NIL)
             (setq |$hasCategoryAlist| NIL)
             (setq |$catNames| NIL)
             (setq |$maximalViews| NIL)
             (setq |$catsig| NIL)
             (setq |$SetFunctions| NIL)
             (setq |$MissingFunctionInfo| NIL)
             (setq |$ConstantAssignments| NIL)
             (setq |$epilogue| NIL)
             (setq |$HackSlot4| NIL)
             (setq |$extraParms| NIL)
             (setq |$devaluateList| NIL)
             (setq |$devaluateList|
                      (PROG (G166745)
                        (setq G166745 NIL)
                        (RETURN
                          (DO ((G166751 |args| (CDR G166751))
                               (|arg| NIL)
                               (G166752 |$ModeVariableList|
                                   (CDR G166752))
                               (|b| NIL))
                              ((OR (ATOM G166751)
                                   (PROGN
                                     (SETQ |arg| (CAR G166751))
                                     NIL)
                                   (ATOM G166752)
                                   (PROGN
                                     (SETQ |b| (CAR G166752))
                                     NIL))
                               (NREVERSE0 G166745))
                            (SEQ (EXIT (SETQ G166745
                                        (CONS (CONS |arg| |b|)
                                         G166745))))))))
             (setq |$supplementaries| NIL)
             (setq |$maximalViews| NIL)
             (setq |oldtime| (get-internal-run-time))
             (setq |$catsig| (CAR |sig|))
             (setq |argsig| (CDR |sig|))
             (setq |catvecListMaker|
                      (REMDUP (CONS (CAR
                                     (|comp| |$catsig| |$EmptyMode|
                                      |$e|))
                                    (PROG (G166765)
                                      (setq G166765 NIL)
                                      (RETURN
                                        (DO
                                         ((G166770
                                           (CADR
                                            (ELT |$domainShell| 4))
                                           (CDR G166770))
                                          (|u| NIL))
                                         ((OR (ATOM G166770)
                                           (PROGN
                                             (SETQ |u| (CAR G166770))
                                             NIL))
                                          (NREVERSE0 G166765))
                                          (SEQ
                                           (EXIT
                                            (SETQ G166765
                                             (CONS
                                              (|compCategories|
                                               (CAR |u|))
                                              G166765))))))))))
             (setq |condCats|
                      (|InvestigateConditions|
                          (CONS |$catsig| (CDR |catvecListMaker|))))
             (setq |makeCatvecCode| (CAR |catvecListMaker|))
             (setq |emptyVector| (VECTOR))
             (setq |domainShell|
                      (make-array (+ 6 |$NRTdeltaLength|)))
             (DO ((|i| 0 (QSADD1 |i|))) ((QSGREATERP |i| 4) NIL)
               (SEQ (EXIT (SETELT |domainShell| |i|
                                  (ELT |$domainShell| |i|)))))
             (setq |$template|
                      (COND
                        ((BOOT-EQUAL |$NRTvec| 'T)
                         (make-array (+ 6 |$NRTdeltaLength|)))
                        ('T NIL)))
             (setq |$catvecList|
                      (CONS |domainShell|
                            (PROG (G166786)
                              (setq G166786 NIL)
                              (RETURN
                                (DO ((G166791
                                      (CADR (ELT |domainShell| 4))
                                      (CDR G166791))
                                     (|u| NIL))
                                    ((OR (ATOM G166791)
                                      (PROGN
                                        (SETQ |u| (CAR G166791))
                                        NIL))
                                     (NREVERSE0 G166786))
                                  (SEQ (EXIT
                                        (SETQ G166786
                                         (CONS |emptyVector| G166786)))))))))
             (setq |$catNames| (CONS '$ NIL))
             (setq |$maximalViews| NIL)
             (setq |$SetFunctions| (make-array (SIZE |domainShell|)))
             (setq |$MissingFunctionInfo|
                      (make-array (SIZE |domainShell|)))
             (setq |$catNames|
                      (CONS '$
                            (PROG (G166801)
                              (setq G166801 NIL)
                              (RETURN
                                (DO ((G166806 (CDR |catvecListMaker|)
                                      (CDR G166806))
                                     (|u| NIL))
                                    ((OR (ATOM G166806)
                                      (PROGN
                                        (SETQ |u| (CAR G166806))
                                        NIL))
                                     (NREVERSE0 G166801))
                                  (SEQ (EXIT
                                        (SETQ G166801
                                         (CONS (GENVAR) G166801)))))))))
             (setq |domname| '|dv$|)
             (setq |LETTMP#1|
                      (|NRTsetVector4Part1| |$catNames|
                          |catvecListMaker| |condCats|))
             (setq |$uncondAlist| (CAR |LETTMP#1|))
             (setq |$condAlist| (CDR |LETTMP#1|))
             (setq |LETTMP#1|
                      (|makePredicateBitVector|
                          (APPEND (ASSOCRIGHT |$condAlist|)
                                  |$NRTslot1PredicateList|)))
             (setq |$NRTslot1PredicateList| (CAR |LETTMP#1|))
             (setq |predBitVectorCode1| (CADR |LETTMP#1|))
             (setq |predBitVectorCode2| (CDDR |LETTMP#1|))
             (setq |storeOperationCode|
                      (|DescendCode| |code| 'T NIL (CAR |$catNames|)))
             (setq |outsideFunctionCode| (|NRTaddDeltaCode|))
             (setq |storeOperationCode|
                      (|NRTputInLocalReferences| |storeOperationCode|))
             (COND
               ((BOOT-EQUAL |$NRTvec| 'T)
                (|NRTdescendCodeTran| |storeOperationCode| NIL)))
             (setq |codePart2|
                      (COND
                        ((BOOT-EQUAL |$NRTvec| 'T)
                         (setq |argStuffCode|
                                  (PROG (G166818)
                                    (setq G166818 NIL)
                                    (RETURN
                                      (DO
                                       ((|i| 6 (+ |i| 1))
                                        (G166825
                                         |$FormalMapVariableList|
                                         (CDR G166825))
                                        (|v| NIL)
                                        (G166826 (CDR |$definition|)
                                         (CDR G166826))
                                        (|arg| NIL))
                                       ((OR (ATOM G166825)
                                         (PROGN
                                           (SETQ |v| (CAR G166825))
                                           NIL)
                                         (ATOM G166826)
                                         (PROGN
                                           (SETQ |arg| (CAR G166826))
                                           NIL))
                                        (NREVERSE0 G166818))
                                        (SEQ
                                         (EXIT
                                          (SETQ G166818
                                           (CONS
                                            (CONS |$setelt|
                                             (CONS '$
                                              (CONS |i| (CONS |v| NIL))))
                                            G166818))))))))
                         (COND
                           ((member |$NRTaddForm| |$locals|)
                            (setq |addargname|
                                     (ELT |$FormalMapVariableList|
                                      (POSN1 |$NRTaddForm| |$locals|)))
                            (setq |argStuffCode|
                                     (CONS
                                      (CONS |$setelt|
                                       (CONS '$
                                        (CONS 5
                                         (CONS |addargname| NIL))))
                                      |argStuffCode|))))
                         (CONS (CONS '|stuffDomainSlots| (CONS '$ NIL))
                               (APPEND |argStuffCode|
                                       (APPEND |predBitVectorCode2|
                                        (CONS |storeOperationCode| NIL)))))
                        ('T
                         (APPEND |outsideFunctionCode|
                                 (CONS |storeOperationCode| NIL)))))
             (setq |$CheckVectorList|
                      (|NRTcheckVector| |domainShell|))
             (setq |devaluateCode|
                      (PROG (G166840)
                        (setq G166840 NIL)
                        (RETURN
                          (DO ((G166846 |$devaluateList|
                                   (CDR G166846))
                               (G166666 NIL))
                              ((OR (ATOM G166846)
                                   (PROGN
                                     (SETQ G166666 (CAR G166846))
                                     NIL)
                                   (PROGN
                                     (PROGN
                                       (setq |a| (CAR G166666))
                                       (setq |b| (CDR G166666))
                                       G166666)
                                     NIL))
                               (NREVERSE0 G166840))
                            (SEQ (EXIT (SETQ G166840
                                        (CONS
                                         (CONS 'LET
                                          (CONS |b|
                                           (CONS
                                            (CONS '|devaluate|
                                             (CONS |a| NIL))
                                            NIL)))
                                         G166840))))))))
             (setq |domainFormCode|
                      (PROG (G166858)
                        (setq G166858 NIL)
                        (RETURN
                          (DO ((G166864
                                   (NREVERSE |$NRTdomainFormList|)
                                   (CDR G166864))
                               (G166670 NIL))
                              ((OR (ATOM G166864)
                                   (PROGN
                                     (SETQ G166670 (CAR G166864))
                                     NIL)
                                   (PROGN
                                     (PROGN
                                       (setq |a| (CAR G166670))
                                       (setq |b| (CDR G166670))
                                       G166670)
                                     NIL))
                               (NREVERSE0 G166858))
                            (SEQ (EXIT (SETQ G166858
                                        (CONS
                                         (CONS 'LET
                                          (CONS |a| (CONS |b| NIL)))
                                         G166858))))))))
             (setq |createDomainCode|
                      (CONS 'LET
                            (CONS |domname|
                                  (CONS (CONS 'LIST
                                         (CONS
                                          (MKQ (CAR |$definition|))
                                          (ASSOCRIGHT |$devaluateList|)))
                                        NIL))))
             (setq |createViewCode|
                      (CONS 'LET
                            (CONS '$
                                  (CONS (CONS 'make-array
                                         (CONS
                                          (+ 6 |$NRTdeltaLength|)
                                          NIL))
                                        NIL))))
             (setq |setVector0Code|
                      (CONS |$setelt|
                            (CONS '$ (CONS 0 (CONS '|dv$| NIL)))))
             (setq |slot3Code|
                      (CONS 'QSETREFV
                            (CONS '$
                                  (CONS 3
                                        (CONS
                                         (CONS 'LET
                                          (CONS '|pv$|
                                           (CONS |predBitVectorCode1|
                                            NIL)))
                                         NIL)))))
             (setq |slamCode|
                      (COND
                        ((|isCategoryPackageName|
                             (|opOf| |$definition|))
                         NIL)
                        ('T
                         (CONS (|NRTaddToSlam| |$definition| '$) NIL))))
             (setq |codePart1|
                      (APPEND |devaluateCode|
                              (APPEND |domainFormCode|
                                      (CONS |createDomainCode|
                                       (CONS |createViewCode|
                                        (CONS |setVector0Code|
                                         (CONS |slot3Code| |slamCode|)))))))
             (setq |$ConstantAssignments|
                      (PROG (G166875)
                        (setq G166875 NIL)
                        (RETURN
                          (DO ((G166880 |$ConstantAssignments|
                                   (CDR G166880))
                               (|code| NIL))
                              ((OR (ATOM G166880)
                                   (PROGN
                                     (SETQ |code| (CAR G166880))
                                     NIL))
                               (NREVERSE0 G166875))
                            (SEQ (EXIT (SETQ G166875
                                        (CONS
                                         (|NRTputInLocalReferences|
                                          |code|)
                                         G166875))))))))
             (setq |constantCode1|
                      (COND
                        ((BOOT-EQUAL |name| '|Integer|)
                         |$ConstantAssignments|)
                        ('T NIL)))
             (setq |constantCode2|
                      (COND
                        ((BOOT-EQUAL |name| '|Integer|) NIL)
                        ('T |$ConstantAssignments|)))
             (setq |epilogue| |$epilogue|)
             (setq |codePart3|
                      (APPEND |constantCode1|
                              (APPEND |constantCode2| |epilogue|)))
             (setq |ans|
                      (CONS 'PROGN
                            (APPEND (|optFunctorPROGN|
                                     (APPEND |codePart1|
                                      (APPEND |codePart2| |codePart3|)))
                                    (CONS '$ NIL))))
             (setq |$getDomainCode| NIL)
             (setq |ans| (|minimalise| |ans|))
             (SAY (CONS "time taken in buildFunctor: "
                       (CONS (- (get-internal-run-time) |oldtime|)
                              NIL)))
             |ans|)))))

;NRTcheckVector domainShell ==
;--RETURNS: an alist (((op,sig),:pred) ...) of missing functions
;  alist := nil
;  for i in 6..MAXINDEX domainShell repeat
;--Vector elements can be one of
;-- (a) T           -- item was marked
;-- (b) NIL         -- item is a domain; will be filled in by setVector4part3
;-- (c) categoryForm-- it was a domain view; now irrelevant
;-- (d) op-signature-- store missing function info in $CheckVectorList
;    v:= domainShell.i
;    v=true => nil  --item is marked; ignore
;    null v => nil  --a domain, which setVector4part3 will fill in
;    atom first v => nil  --category form; ignore
;    atom v => systemErrorHere '"CheckVector"
;    ASSOC(first v,alist) => nil
;    alist:=
;      [[first v,:$SetFunctions.i],:alist]
;  alist

(DEFUN |NRTcheckVector| (|domainShell|)
  (PROG (|v| |alist|)
  (declare (special |$SetFunctions|))
    (RETURN
      (SEQ (PROGN
             (setq |alist| NIL)
             (DO ((G167008 (MAXINDEX |domainShell|))
                  (|i| 6 (+ |i| 1)))
                 ((> |i| G167008) NIL)
               (SEQ (EXIT (PROGN
                            (setq |v| (ELT |domainShell| |i|))
                            (COND
                              ((BOOT-EQUAL |v| 'T) NIL)
                              ((NULL |v|) NIL)
                              ((ATOM (CAR |v|)) NIL)
                              ((ATOM |v|)
                               (|systemErrorHere|
                                   "CheckVector"))
                              ((|assoc| (CAR |v|) |alist|) NIL)
                              ('T
                               (setq |alist|
                                        (CONS
                                         (CONS (CAR |v|)
                                          (ELT |$SetFunctions| |i|))
                                         |alist|))))))))
             |alist|)))))

;-- Obsolete once we have moved to JHD's world
;NRTvectorCopy(cacheName,domName,deltaLength) == GETREFV (6 + deltaLength)

(DEFUN |NRTvectorCopy| (|cacheName| |domName| |deltaLength|)
  (declare (ignore |cacheName| |domName| ))
  (make-array (+ 6 |deltaLength|)))

;mkDomainCatName id == INTERN STRCONC(id,";CAT")

(DEFUN |mkDomainCatName| (|id|) (INTERN (STRCONC |id| '|;CAT|)))

;NRTsetVector4(siglist,formlist,condlist) ==
;  $uncondList: local := nil
;  $condList: local := nil
;  $count: local := 0
;  for sig in reverse siglist for form in reverse formlist
;         for cond in reverse condlist repeat
;                  NRTsetVector4a(sig,form,cond)
;  --NRTsetVector4a(first siglist,first formlist,first condlist)
;  $lisplibCategoriesExtended:= [$uncondList,:$condList]
;  code := ['mapConsDB,MKQ REVERSE REMDUP $uncondList]
;  if $condList then
;    localVariable := GENSYM()
;    code := [['LET,localVariable,code]]
;    for [pred,list] in $condList repeat
;      code :=
;        [['COND,[pred,['LET,localVariable,
;          ['mergeAppend,['mapConsDB,MKQ list],localVariable]]]],
;            :code]
;    code := ['PROGN,:NREVERSE [['NREVERSE,localVariable],:code]]
;  g := GENSYM()
;  [$setelt,'$,4,['PROG2,['LET,g,code],
;    ['VECTOR,['catList2catPackageList,g],g]]]

(DEFUN |NRTsetVector4| (|siglist| |formlist| |condlist|)
  (PROG (|$uncondList| |$condList| |$count| |localVariable| |pred| LIST
            |code| |g|)
    (DECLARE (SPECIAL |$uncondList| |$condList| |$count| |$setelt|
                      |$lisplibCategoriesExtended|))
    (RETURN
      (SEQ (PROGN
             (setq |$uncondList| NIL)
             (setq |$condList| NIL)
             (setq |$count| 0)
             (DO ((G167035 (REVERSE |siglist|) (CDR G167035))
                  (|sig| NIL)
                  (G167036 (REVERSE |formlist|) (CDR G167036))
                  (|form| NIL)
                  (G167037 (REVERSE |condlist|) (CDR G167037))
                  (|cond| NIL))
                 ((OR (ATOM G167035)
                      (PROGN (SETQ |sig| (CAR G167035)) NIL)
                      (ATOM G167036)
                      (PROGN (SETQ |form| (CAR G167036)) NIL)
                      (ATOM G167037)
                      (PROGN (SETQ |cond| (CAR G167037)) NIL))
                  NIL)
               (SEQ (EXIT (|NRTsetVector4a| |sig| |form| |cond|))))
             (setq |$lisplibCategoriesExtended|
                      (CONS |$uncondList| |$condList|))
             (setq |code|
                      (CONS '|mapConsDB|
                            (CONS (MKQ (REVERSE (REMDUP |$uncondList|)))
                                  NIL)))
             (COND
               (|$condList| (setq |localVariable| (GENSYM))
                   (setq |code|
                            (CONS (CONS 'LET
                                        (CONS |localVariable|
                                         (CONS |code| NIL)))
                                  NIL))
                   (DO ((G167053 |$condList| (CDR G167053))
                        (G167024 NIL))
                       ((OR (ATOM G167053)
                            (PROGN
                              (SETQ G167024 (CAR G167053))
                              NIL)
                            (PROGN
                              (PROGN
                                (setq |pred| (CAR G167024))
                                (setq LIST (CADR G167024))
                                G167024)
                              NIL))
                        NIL)
                     (SEQ (EXIT (setq |code|
                                         (CONS
                                          (CONS 'COND
                                           (CONS
                                            (CONS |pred|
                                             (CONS
                                              (CONS 'LET
                                               (CONS |localVariable|
                                                (CONS
                                                 (CONS '|mergeAppend|
                                                  (CONS
                                                   (CONS '|mapConsDB|
                                                    (CONS (MKQ LIST)
                                                     NIL))
                                                   (CONS
                                                    |localVariable|
                                                    NIL)))
                                                 NIL)))
                                              NIL))
                                            NIL))
                                          |code|)))))
                   (setq |code|
                            (CONS 'PROGN
                                  (NREVERSE
                                      (CONS
                                       (CONS 'NREVERSE
                                        (CONS |localVariable| NIL))
                                       |code|))))))
             (setq |g| (GENSYM))
             (CONS |$setelt|
                   (CONS '$
                         (CONS 4
                               (CONS (CONS 'PROG2
                                      (CONS
                                       (CONS 'LET
                                        (CONS |g| (CONS |code| NIL)))
                                       (CONS
                                        (CONS 'VECTOR
                                         (CONS
                                          (CONS
                                           '|catList2catPackageList|
                                           (CONS |g| NIL))
                                          (CONS |g| NIL)))
                                        NIL)))
                                     NIL)))))))))

;NRTsetVector4Part1(siglist,formlist,condlist) ==
;  $uncondList: local := nil
;  $condList: local := nil
;  $count: local := 0
;  for sig in reverse siglist for form in reverse formlist
;         for cond in reverse condlist repeat
;                  NRTsetVector4a(sig,form,cond)
;  reducedUncondlist := REMDUP $uncondList
;  reducedConlist :=
;    [[x,:y] for [x,z] in $condList| y := SETDIFFERENCE(z,reducedUncondlist)]
;  revCondlist := reverseCondlist reducedConlist
;  orCondlist := [[x,:MKPF(y,'OR)] for [x,:y] in revCondlist]
;  [reducedUncondlist,:orCondlist]

(DEFUN |NRTsetVector4Part1| (|siglist| |formlist| |condlist|)
  (PROG (|$uncondList| |$condList| |$count| |reducedUncondlist| |z|
            |reducedConlist| |revCondlist| |x| |y| |orCondlist|)
    (DECLARE (SPECIAL |$uncondList| |$condList| |$count|))
    (RETURN
      (SEQ (PROGN
             (setq |$uncondList| NIL)
             (setq |$condList| NIL)
             (setq |$count| 0)
             (DO ((G167095 (REVERSE |siglist|) (CDR G167095))
                  (|sig| NIL)
                  (G167096 (REVERSE |formlist|) (CDR G167096))
                  (|form| NIL)
                  (G167097 (REVERSE |condlist|) (CDR G167097))
                  (|cond| NIL))
                 ((OR (ATOM G167095)
                      (PROGN (SETQ |sig| (CAR G167095)) NIL)
                      (ATOM G167096)
                      (PROGN (SETQ |form| (CAR G167096)) NIL)
                      (ATOM G167097)
                      (PROGN (SETQ |cond| (CAR G167097)) NIL))
                  NIL)
               (SEQ (EXIT (|NRTsetVector4a| |sig| |form| |cond|))))
             (setq |reducedUncondlist| (REMDUP |$uncondList|))
             (setq |reducedConlist|
                      (PROG (G167115)
                        (setq G167115 NIL)
                        (RETURN
                          (DO ((G167122 |$condList| (CDR G167122))
                               (G167081 NIL))
                              ((OR (ATOM G167122)
                                   (PROGN
                                     (SETQ G167081 (CAR G167122))
                                     NIL)
                                   (PROGN
                                     (PROGN
                                       (setq |x| (CAR G167081))
                                       (setq |z| (CADR G167081))
                                       G167081)
                                     NIL))
                               (NREVERSE0 G167115))
                            (SEQ (EXIT (COND
                                         ((setq |y|
                                           (SETDIFFERENCE |z|
                                            |reducedUncondlist|))
                                          (SETQ G167115
                                           (CONS (CONS |x| |y|)
                                            G167115))))))))))
             (setq |revCondlist|
                      (|reverseCondlist| |reducedConlist|))
             (setq |orCondlist|
                      (PROG (G167134)
                        (setq G167134 NIL)
                        (RETURN
                          (DO ((G167140 |revCondlist|
                                   (CDR G167140))
                               (G167085 NIL))
                              ((OR (ATOM G167140)
                                   (PROGN
                                     (SETQ G167085 (CAR G167140))
                                     NIL)
                                   (PROGN
                                     (PROGN
                                       (setq |x| (CAR G167085))
                                       (setq |y| (CDR G167085))
                                       G167085)
                                     NIL))
                               (NREVERSE0 G167134))
                            (SEQ (EXIT (SETQ G167134
                                        (CONS (CONS |x| (MKPF |y| 'OR))
                                         G167134))))))))
             (CONS |reducedUncondlist| |orCondlist|))))))

;  --NRTsetVector4a(first siglist,first formlist,first condlist)
;reverseCondlist cl ==
;  alist := nil
;  for [x,:y] in cl repeat
;    for z in y repeat
;      u := ASSOC(z,alist)
;      null u => alist := [[z,x],:alist]
;      MEMBER(x,CDR u) => nil
;      RPLACD(u,[x,:CDR u])
;  alist

(DEFUN |reverseCondlist| (|cl|)
  (PROG (|x| |y| |u| |alist|)
    (RETURN
      (SEQ (PROGN
             (setq |alist| NIL)
             (DO ((G167182 |cl| (CDR G167182)) (G167171 NIL))
                 ((OR (ATOM G167182)
                      (PROGN (SETQ G167171 (CAR G167182)) NIL)
                      (PROGN
                        (PROGN
                          (setq |x| (CAR G167171))
                          (setq |y| (CDR G167171))
                          G167171)
                        NIL))
                  NIL)
               (SEQ (EXIT (DO ((G167194 |y| (CDR G167194))
                               (|z| NIL))
                              ((OR (ATOM G167194)
                                   (PROGN
                                     (SETQ |z| (CAR G167194))
                                     NIL))
                               NIL)
                            (SEQ (EXIT (PROGN
                                         (setq |u|
                                          (|assoc| |z| |alist|))
                                         (COND
                                           ((NULL |u|)
                                            (setq |alist|
                                             (CONS
                                              (CONS |z| (CONS |x| NIL))
                                              |alist|)))
                                           ((|member| |x| (CDR |u|))
                                            NIL)
                                           ('T
                                            (RPLACD |u|
                                             (CONS |x| (CDR |u|))))))))))))
             |alist|)))))

;NRTsetVector4Part2(uncondList,condList) ==
;  $lisplibCategoriesExtended:= [uncondList,:condList]
;  code := ['mapConsDB,MKQ REVERSE REMDUP uncondList]
;  if condList then
;    localVariable := GENSYM()
;    code := [['LET,localVariable,code]]
;    for [pred,list] in condList repeat
;      code :=
;        [['COND,[predicateBitRef SUBLIS($pairlis,pred),['LET,localVariable,
;          ['mergeAppend,['mapConsDB,MKQ list],localVariable]]]],
;            :code]
;    code := ['PROGN,:NREVERSE [['NREVERSE,localVariable],:code]]
;  g := GENSYM()
;  [$setelt,'$,4,['PROG2,['LET,g,code],
;    ['VECTOR,['catList2catPackageList,g],g]]]

(DEFUN |NRTsetVector4Part2| (|uncondList| |condList|)
  (PROG (|localVariable| |pred| LIST |code| |g|)
  (declare (special |$setelt| |$pairlis| |$lisplibCategoriesExtended|))
    (RETURN
      (SEQ (PROGN
             (setq |$lisplibCategoriesExtended|
                      (CONS |uncondList| |condList|))
             (setq |code|
                      (CONS '|mapConsDB|
                            (CONS (MKQ (REVERSE (REMDUP |uncondList|)))
                                  NIL)))
             (COND
               (|condList| (setq |localVariable| (GENSYM))
                   (setq |code|
                            (CONS (CONS 'LET
                                        (CONS |localVariable|
                                         (CONS |code| NIL)))
                                  NIL))
                   (DO ((G167218 |condList| (CDR G167218))
                        (G167208 NIL))
                       ((OR (ATOM G167218)
                            (PROGN
                              (SETQ G167208 (CAR G167218))
                              NIL)
                            (PROGN
                              (PROGN
                                (setq |pred| (CAR G167208))
                                (setq LIST (CADR G167208))
                                G167208)
                              NIL))
                        NIL)
                     (SEQ (EXIT (setq |code|
                                         (CONS
                                          (CONS 'COND
                                           (CONS
                                            (CONS
                                             (|predicateBitRef|
                                              (SUBLIS |$pairlis|
                                               |pred|))
                                             (CONS
                                              (CONS 'LET
                                               (CONS |localVariable|
                                                (CONS
                                                 (CONS '|mergeAppend|
                                                  (CONS
                                                   (CONS '|mapConsDB|
                                                    (CONS (MKQ LIST)
                                                     NIL))
                                                   (CONS
                                                    |localVariable|
                                                    NIL)))
                                                 NIL)))
                                              NIL))
                                            NIL))
                                          |code|)))))
                   (setq |code|
                            (CONS 'PROGN
                                  (NREVERSE
                                      (CONS
                                       (CONS 'NREVERSE
                                        (CONS |localVariable| NIL))
                                       |code|))))))
             (setq |g| (GENSYM))
             (CONS |$setelt|
                   (CONS '$
                         (CONS 4
                               (CONS (CONS 'PROG2
                                      (CONS
                                       (CONS 'LET
                                        (CONS |g| (CONS |code| NIL)))
                                       (CONS
                                        (CONS 'VECTOR
                                         (CONS
                                          (CONS
                                           '|catList2catPackageList|
                                           (CONS |g| NIL))
                                          (CONS |g| NIL)))
                                        NIL)))
                                     NIL)))))))))

;mergeAppend(l1,l2) ==
;  ATOM l1 => l2
;  member(QCAR l1,l2) => mergeAppend(QCDR l1, l2)
;  CONS(QCAR l1, mergeAppend(QCDR l1, l2))

(DEFUN |mergeAppend| (|l1| |l2|)
  (COND
    ((ATOM |l1|) |l2|)
    ((|member| (QCAR |l1|) |l2|) (|mergeAppend| (QCDR |l1|) |l2|))
    ('T (CONS (QCAR |l1|) (|mergeAppend| (QCDR |l1|) |l2|)))))

;--genLoadTimeValue u ==
;--  name :=
;--    INTERN STRCONC(PNAME first $definition,'";",STRINGIZE($count:=$count+1))
;--  $NRTloadTimeAlist := [[name,:['addConsDB,MKQ u]],:$NRTloadTimeAlist]
;--  --see compDefineFunctor1
;--  name
;catList2catPackageList u ==
;--converts ((Set) (Module R) ...) to ((Set& $) (Module& $ R)...)
;  [fn x for x in u] where
;    fn [op,:argl] ==
;      newOp := INTERN(STRCONC(PNAME op,"&"))
;      addConsDB [newOp,"$",:argl]

(DEFUN |catList2catPackageList,fn| (G167242)
  (PROG (|op| |argl| |newOp|)
    (RETURN
      (SEQ (PROGN
             (setq |op| (CAR G167242))
             (setq |argl| (CDR G167242))
             G167242
             (SEQ (setq |newOp| (INTERN (STRCONC (PNAME |op|) '&)))
                  (EXIT (CONS |newOp| (CONS '$ |argl|)))))))))

(DEFUN |catList2catPackageList| (|u|)
  (PROG ()
    (RETURN
      (SEQ (PROG (G167262)
             (setq G167262 NIL)
             (RETURN
               (DO ((G167267 |u| (CDR G167267)) (|x| NIL))
                   ((OR (ATOM G167267)
                        (PROGN (SETQ |x| (CAR G167267)) NIL))
                    (NREVERSE0 G167262))
                 (SEQ (EXIT (SETQ G167262
                                  (CONS (|catList2catPackageList,fn|
                                         |x|)
                                        G167262)))))))))))

;NRTsetVector4a(sig,form,cond) ==
;  sig = '$ =>
;     domainList :=
;       [optimize COPY KAR comp(d,$EmptyMode,$e) or d for d in $domainShell.4.0]
;     $uncondList := APPEND(domainList,$uncondList)
;     if isCategoryForm(form,$e) then $uncondList := [form,:$uncondList]
;     $uncondList
;  evalform := eval mkEvalableCategoryForm form
;  cond = true => $uncondList := [form,:APPEND(evalform.4.0,$uncondList)]
;  $condList := [[cond,[form,:evalform.4.0]],:$condList]

(DEFUN |NRTsetVector4a| (|sig| |form| |cond|)
  (PROG (|domainList| |evalform|)
  (declare (special |$condList| |$uncondList| |$e| |$EmptyMode| 
                    |$domainShell|))
    (RETURN
      (SEQ (COND
             ((BOOT-EQUAL |sig| '$)
              (setq |domainList|
                       (PROG (G167283)
                         (setq G167283 NIL)
                         (RETURN
                           (DO ((G167288
                                    (ELT (ELT |$domainShell| 4) 0)
                                    (CDR G167288))
                                (|d| NIL))
                               ((OR (ATOM G167288)
                                    (PROGN
                                      (SETQ |d| (CAR G167288))
                                      NIL))
                                (NREVERSE0 G167283))
                             (SEQ (EXIT (SETQ G167283
                                         (CONS
                                          (OR
                                           (|optimize|
                                            (COPY
                                             (ifcar
                                              (|comp| |d| |$EmptyMode|
                                               |$e|))))
                                           |d|)
                                          G167283))))))))
              (setq |$uncondList|
                       (APPEND |domainList| |$uncondList|))
              (COND
                ((|isCategoryForm| |form| |$e|)
                 (setq |$uncondList| (CONS |form| |$uncondList|))))
              |$uncondList|)
             ('T
              (setq |evalform|
                       (|eval| (|mkEvalableCategoryForm| |form|)))
              (COND
                ((BOOT-EQUAL |cond| 'T)
                 (setq |$uncondList|
                          (CONS |form|
                                (APPEND (ELT (ELT |evalform| 4) 0)
                                        |$uncondList|))))
                ('T
                 (setq |$condList|
                          (CONS (CONS |cond|
                                      (CONS
                                       (CONS |form|
                                        (ELT (ELT |evalform| 4) 0))
                                       NIL))
                                |$condList|))))))))))

;NRTmakeSlot1 domainShell ==
;  opDirectName := INTERN STRCONC(PNAME first $definition,'";opDirect")
;  fun :=
;    $NRTmakeCompactDirect => '(function lookupInCompactTable)
;    '(function lookupInTable)
;  [($QuickCode=>'QSETREFV;'SETELT), '$,1, ['LIST,fun,'$,opDirectName]]

(DEFUN |NRTmakeSlot1| (|domainShell|)
  (declare (ignore |domainShell|))
  (PROG (|opDirectName| |fun|)
  (declare (special |$QuickCode| |$NRTmakeCompactDirect| |$definition|))
    (RETURN
      (PROGN
        (setq |opDirectName|
                 (INTERN (STRCONC (PNAME (CAR |$definition|))
                                  ";opDirect")))
        (setq |fun|
                 (COND
                   (|$NRTmakeCompactDirect|
                       '(function |lookupInCompactTable|))
                   ('T '(function |lookupInTable|))))
        (CONS (COND (|$QuickCode| 'QSETREFV) ('T 'SETELT))
              (CONS '$
                    (CONS 1
                          (CONS (CONS 'LIST
                                      (CONS |fun|
                                       (CONS '$
                                        (CONS |opDirectName| NIL))))
                                NIL))))))))

;NRTmakeSlot1Info() ==
;-- 4 cases:
;-- a:T == b add c  --- slot1 directory has #s for entries defined in c
;-- a:T == b        --- slot1 has all slot #s = NIL (see compFunctorBody)
;-- a == b add c    --- not allowed (line 7 of getTargetFromRhs)
;-- a == b          --- $NRTderivedTargetIfTrue = true; set directory to NIL
;  pairlis :=
;    $insideCategoryPackageIfTrue = true =>
;      [:argl,dollarName] := rest $form
;      [[dollarName,:'_$],:mkSlot1sublis argl]
;    mkSlot1sublis rest $form
;  $lisplibOpAlist := transformOperationAlist SUBLIS(pairlis,$domainShell.1)
;  opList :=
;    $NRTderivedTargetIfTrue => 'derived
;    $insideCategoryPackageIfTrue = true => slot1Filter $lisplibOpAlist
;    $lisplibOpAlist
;  addList := SUBLIS(pairlis,$NRTaddForm)
;  [first $form,[addList,:opList]]

(DEFUN |NRTmakeSlot1Info| ()
  (PROG (|LETTMP#1| |LETTMP#2| |dollarName| |argl| |pairlis| |opList|
            |addList|)
  (declare (special |$form| |$NRTaddForm| |$lisplibOpAlist| |$domainShell|
                    |$insideCategoryPackageIfTrue| |$NRTderivedTargetIfTrue|))
    (RETURN
      (PROGN
        (setq |pairlis|
                 (COND
                   ((BOOT-EQUAL |$insideCategoryPackageIfTrue| 'T)
                    (setq |LETTMP#1| (CDR |$form|))
                    (setq |LETTMP#2| (REVERSE |LETTMP#1|))
                    (setq |dollarName| (CAR |LETTMP#2|))
                    (setq |argl| (NREVERSE (CDR |LETTMP#2|)))
                    (CONS (CONS |dollarName| '$)
                          (|mkSlot1sublis| |argl|)))
                   ('T (|mkSlot1sublis| (CDR |$form|)))))
        (setq |$lisplibOpAlist|
                 (|transformOperationAlist|
                     (SUBLIS |pairlis| (ELT |$domainShell| 1))))
        (setq |opList|
                 (COND
                   (|$NRTderivedTargetIfTrue| '|derived|)
                   ((BOOT-EQUAL |$insideCategoryPackageIfTrue| 'T)
                    (|slot1Filter| |$lisplibOpAlist|))
                   ('T |$lisplibOpAlist|)))
        (setq |addList| (SUBLIS |pairlis| |$NRTaddForm|))
        (CONS (CAR |$form|) (CONS (CONS |addList| |opList|) NIL))))))

;mkSlot1sublis argl ==
;  [[a,:b] for a in argl for b in $FormalMapVariableList]

(DEFUN |mkSlot1sublis| (|argl|)
  (PROG ()
  (declare (special |$FormalMapVariableList|))
    (RETURN
      (SEQ (PROG (G167341)
             (setq G167341 NIL)
             (RETURN
               (DO ((G167347 |argl| (CDR G167347)) (|a| NIL)
                    (G167348 |$FormalMapVariableList|
                        (CDR G167348))
                    (|b| NIL))
                   ((OR (ATOM G167347)
                        (PROGN (SETQ |a| (CAR G167347)) NIL)
                        (ATOM G167348)
                        (PROGN (SETQ |b| (CAR G167348)) NIL))
                    (NREVERSE0 G167341))
                 (SEQ (EXIT (SETQ G167341
                                  (CONS (CONS |a| |b|) G167341)))))))))))

;slot1Filter opList ==
;--include only those ops which are defined within the capsule
;  [u for x in opList | u := fn x] where
;    fn [op,:l] ==
;      u := [entry for entry in l | INTEGERP CADR entry] => [op,:u]
;      nil

(DEFUN |slot1Filter,fn| (G167362)
  (PROG (|op| |l| |u|)
    (RETURN
      (SEQ (PROGN
             (setq |op| (CAR G167362))
             (setq |l| (CDR G167362))
             G167362
             (SEQ (IF (setq |u|
                               (PROG (G167376)
                                 (setq G167376 NIL)
                                 (RETURN
                                   (DO
                                    ((G167382 |l| (CDR G167382))
                                     (|entry| NIL))
                                    ((OR (ATOM G167382)
                                      (PROGN
                                        (SETQ |entry| (CAR G167382))
                                        NIL))
                                     (NREVERSE0 G167376))
                                     (SEQ
                                      (EXIT
                                       (COND
                                         ((INTEGERP (CADR |entry|))
                                          (SETQ G167376
                                           (CONS |entry| G167376))))))))))
                      (EXIT (CONS |op| |u|)))
                  (EXIT NIL)))))))

(DEFUN |slot1Filter| (|opList|)
  (PROG (|u|)
    (RETURN
      (SEQ (PROG (G167401)
             (setq G167401 NIL)
             (RETURN
               (DO ((G167407 |opList| (CDR G167407)) (|x| NIL))
                   ((OR (ATOM G167407)
                        (PROGN (SETQ |x| (CAR G167407)) NIL))
                    (NREVERSE0 G167401))
                 (SEQ (EXIT (COND
                              ((setq |u| (|slot1Filter,fn| |x|))
                               (SETQ G167401 (CONS |u| G167401)))))))))))))

;NRToptimizeHas u ==
;--u is a list ((pred cond)...) -- see optFunctorBody
;--produces an alist: (((HasCategory a b) . GENSYM)...)
;  u is [a,:b] =>
;    a='HasCategory => LASSOC(u,$hasCategoryAlist) or
;      $hasCategoryAlist := [[u,:(y:=GENSYM())],:$hasCategoryAlist]
;      y
;    a='has => NRToptimizeHas ['HasCategory,first b,MKQ first rest b]
;    a = 'QUOTE => u
;    [NRToptimizeHas a,:NRToptimizeHas b]
;  u

(DEFUN |NRToptimizeHas| (|u|)
  (PROG (|a| |b| |y|)
  (declare (special |$hasCategoryAlist|))
    (RETURN
      (COND
        ((AND (CONSP |u|)
              (PROGN
                (setq |a| (QCAR |u|))
                (setq |b| (QCDR |u|))
                'T))
         (COND
           ((BOOT-EQUAL |a| '|HasCategory|)
            (OR (LASSOC |u| |$hasCategoryAlist|)
                (PROGN
                  (setq |$hasCategoryAlist|
                           (CONS (CONS |u| (setq |y| (GENSYM)))
                                 |$hasCategoryAlist|))
                  |y|)))
           ((BOOT-EQUAL |a| '|has|)
            (|NRToptimizeHas|
                (CONS '|HasCategory|
                      (CONS (CAR |b|) (CONS (MKQ (CAR (CDR |b|))) NIL)))))
           ((BOOT-EQUAL |a| 'QUOTE) |u|)
           ('T (CONS (|NRToptimizeHas| |a|) (|NRToptimizeHas| |b|)))))
        ('T |u|)))))

;NRTaddToSlam([name,:argnames],shell) ==
;  $mutableDomain => return nil
;  null argnames => addToConstructorCache(name,nil,shell)
;  args:= ['LIST,:ASSOCRIGHT $devaluateList]
;  addToConstructorCache(name,args,shell)

(DEFUN |NRTaddToSlam| (G167432 |shell|)
  (PROG (|name| |argnames| |args|)
  (declare (special |$devaluateList| |$mutableDomain|))
    (RETURN
      (PROGN
        (setq |name| (CAR G167432))
        (setq |argnames| (CDR G167432))
        (COND
          (|$mutableDomain| (RETURN NIL))
          ((NULL |argnames|)
           (|addToConstructorCache| |name| NIL |shell|))
          ('T
           (setq |args| (CONS 'LIST (ASSOCRIGHT |$devaluateList|)))
           (|addToConstructorCache| |name| |args| |shell|)))))))

;changeDirectoryInSlot1() ==  --called by NRTbuildFunctor
;  --3 cases:
;  --  if called inside NRTbuildFunctor, $NRTdeltaLength gives different locs
;  --  otherwise called from compFunctorBody (all lookups are forwarded):
;  --    $NRTdeltaList = nil  ===> all slot numbers become nil
;  $lisplibOperationAlist := [sigloc entry for entry in $domainShell.1] where
;    sigloc [opsig,pred,fnsel] ==
;        if pred ^= 'T then
;          pred := simpBool pred
;          $NRTslot1PredicateList := insert(pred,$NRTslot1PredicateList)
;        fnsel is [op,a,:.] and (op = 'ELT or op = 'CONST) =>
;          if $insideCategoryPackageIfTrue then
;              opsig := substitute('$,CADR($functorForm),opsig)
;          [opsig,pred,[op,a,vectorLocation(first opsig,CADR opsig)]]
;        [opsig,pred,fnsel]
;  sortedOplist := listSort(function GLESSEQP,
;                           COPY_-LIST $lisplibOperationAlist,function CADR)
;  $lastPred :local := nil
;  $newEnv :local := $e
;  $domainShell.1 := [fn entry for entry in sortedOplist] where
;    fn [[op,sig],pred,fnsel] ==
;       if $lastPred ^= pred then
;            $newEnv := deepChaseInferences(pred,$e)
;            $lastPred := pred
;       newfnsel :=
;         fnsel is ['Subsumed,op1,sig1] =>
;           ['Subsumed,op1,genSlotSig(sig1,'T,$newEnv)]
;         fnsel
;       [[op, genSlotSig(sig,pred,$newEnv)] ,pred,newfnsel]

(DEFUN |changeDirectoryInSlot1,sigloc| (G167459)
  (PROG (|fnsel| |pred| |op| |ISTMP#1| |a| |opsig|)
  (declare (special |$functorForm| |$insideCategoryPackageIfTrue|
                    |$NRTslot1PredicateList|))
    (RETURN
      (SEQ (PROGN
             (setq |opsig| (CAR G167459))
             (setq |pred| (CADR G167459))
             (setq |fnsel| (CADDR G167459))
             G167459
             (SEQ (IF (NEQUAL |pred| 'T)
                      (SEQ (setq |pred| (|simpBool| |pred|))
                           (EXIT (setq |$NRTslot1PredicateList|
                                          (|insert| |pred|
                                           |$NRTslot1PredicateList|))))
                      NIL)
                  (IF (AND (AND (CONSP |fnsel|)
                                (PROGN
                                  (setq |op| (QCAR |fnsel|))
                                  (setq |ISTMP#1| (QCDR |fnsel|))
                                  (AND (CONSP |ISTMP#1|)
                                       (PROGN
                                         (setq |a| (QCAR |ISTMP#1|))
                                         'T))))
                           (OR (BOOT-EQUAL |op| 'ELT)
                               (BOOT-EQUAL |op| 'CONST)))
                      (EXIT (SEQ (IF |$insideCategoryPackageIfTrue|
                                     (setq |opsig|
                                      (MSUBST '$ (CADR |$functorForm|)
                                       |opsig|))
                                     NIL)
                                 (EXIT (CONS |opsig|
                                        (CONS |pred|
                                         (CONS
                                          (CONS |op|
                                           (CONS |a|
                                            (CONS
                                             (|vectorLocation|
                                              (CAR |opsig|)
                                              (CADR |opsig|))
                                             NIL)))
                                          NIL)))))))
                  (EXIT (CONS |opsig| (CONS |pred| (CONS |fnsel| NIL))))))))))

(DEFUN |changeDirectoryInSlot1,fn| (G167507)
  (PROG (|op| |sig| |pred| |fnsel| |ISTMP#1| |op1| |ISTMP#2| |sig1|
              |newfnsel|)
  (declare (special |$newEnv| |$lastPred| |$e|))
    (RETURN
      (SEQ (PROGN
             (setq |op| (CAAR G167507))
             (setq |sig| (CADAR G167507))
             (setq |pred| (CADR G167507))
             (setq |fnsel| (CADDR G167507))
             G167507
             (SEQ (IF (NEQUAL |$lastPred| |pred|)
                      (SEQ (setq |$newEnv|
                                    (|deepChaseInferences| |pred| |$e|))
                           (EXIT (setq |$lastPred| |pred|)))
                      NIL)
                  (setq |newfnsel|
                           (SEQ (IF (AND (CONSP |fnsel|)
                                     (EQ (QCAR |fnsel|) '|Subsumed|)
                                     (PROGN
                                       (setq |ISTMP#1|
                                        (QCDR |fnsel|))
                                       (AND (CONSP |ISTMP#1|)
                                        (PROGN
                                          (setq |op1|
                                           (QCAR |ISTMP#1|))
                                          (setq |ISTMP#2|
                                           (QCDR |ISTMP#1|))
                                          (AND (CONSP |ISTMP#2|)
                                           (EQ (QCDR |ISTMP#2|) NIL)
                                           (PROGN
                                             (setq |sig1|
                                              (QCAR |ISTMP#2|))
                                             'T))))))
                                    (EXIT
                                     (CONS '|Subsumed|
                                      (CONS |op1|
                                       (CONS
                                        (|genSlotSig| |sig1| 'T
                                         |$newEnv|)
                                        NIL)))))
                                (EXIT |fnsel|)))
                  (EXIT (CONS (CONS |op|
                                    (CONS
                                     (|genSlotSig| |sig| |pred|
                                      |$newEnv|)
                                     NIL))
                              (CONS |pred| (CONS |newfnsel| NIL))))))))))

(DEFUN |changeDirectoryInSlot1| ()
  (PROG (|$lastPred| |$newEnv| |sortedOplist|)
    (DECLARE (SPECIAL |$lastPred| |$newEnv| |$domainShell| 
                      |$lisplibOperationAlist|))
    (RETURN
      (SEQ (PROGN
             (setq |$lisplibOperationAlist|
                      (PROG (G167547)
                        (setq G167547 NIL)
                        (RETURN
                          (DO ((G167552 (ELT |$domainShell| 1)
                                   (CDR G167552))
                               (|entry| NIL))
                              ((OR (ATOM G167552)
                                   (PROGN
                                     (SETQ |entry| (CAR G167552))
                                     NIL))
                               (NREVERSE0 G167547))
                            (SEQ (EXIT (SETQ G167547
                                        (CONS
                                         (|changeDirectoryInSlot1,sigloc|
                                          |entry|)
                                         G167547))))))))
             (setq |sortedOplist|
                      (|listSort| #'GLESSEQP
                          (COPY-LIST |$lisplibOperationAlist|)
                          #'CADR))
             (setq |$lastPred| NIL)
             (setq |$newEnv| |$e|)
             (SETELT |$domainShell| 1
                     (PROG (G167562)
                       (setq G167562 NIL)
                       (RETURN
                         (DO ((G167567 |sortedOplist|
                                  (CDR G167567))
                              (|entry| NIL))
                             ((OR (ATOM G167567)
                                  (PROGN
                                    (SETQ |entry| (CAR G167567))
                                    NIL))
                              (NREVERSE0 G167562))
                           (SEQ (EXIT (SETQ G167562
                                       (CONS
                                        (|changeDirectoryInSlot1,fn|
                                         |entry|)
                                        G167562)))))))))))))

;genSlotSig(sig,pred,$e) ==
;   [genDeltaSig t for t in sig]

(DEFUN |genSlotSig| (|sig| |pred| |$e|)
  (DECLARE (SPECIAL |$e|) (ignore |pred|))
  (PROG ()
    (RETURN
      (SEQ (PROG (G167590)
             (setq G167590 NIL)
             (RETURN
               (DO ((G167595 |sig| (CDR G167595)) (|t| NIL))
                   ((OR (ATOM G167595)
                        (PROGN (SETQ |t| (CAR G167595)) NIL))
                    (NREVERSE0 G167590))
                 (SEQ (EXIT (SETQ G167590
                                 (CONS (|genDeltaSig| |t|) G167590)))))))))))

;deepChaseInferences(pred,$e) ==
;    pred is ['AND,:preds] or pred is ['and,:preds] =>
;        for p in preds repeat $e := deepChaseInferences(p,$e)
;        $e
;    pred is ['OR,pred1,:.] or pred is ['or,pred1,:.] =>
;        deepChaseInferences(pred1,$e)
;    pred is 'T or pred is ['NOT,:.] or pred is ['not,:.] => $e
;    chaseInferences(pred,$e)

(DEFUN |deepChaseInferences| (|pred| |$e|)
  (DECLARE (SPECIAL |$e|))
  (PROG (|preds| |ISTMP#1| |pred1|)
    (RETURN
      (SEQ (COND
             ((OR (AND (CONSP |pred|) (EQ (QCAR |pred|) 'AND)
                       (PROGN (setq |preds| (QCDR |pred|)) 'T))
                  (AND (CONSP |pred|) (EQ (QCAR |pred|) '|and|)
                       (PROGN (setq |preds| (QCDR |pred|)) 'T)))
              (DO ((G167619 |preds| (CDR G167619)) (|p| NIL))
                  ((OR (ATOM G167619)
                       (PROGN (SETQ |p| (CAR G167619)) NIL))
                   NIL)
                (SEQ (EXIT (setq |$e|
                                    (|deepChaseInferences| |p| |$e|)))))
              |$e|)
             ((OR (AND (CONSP |pred|) (EQ (QCAR |pred|) 'OR)
                       (PROGN
                         (setq |ISTMP#1| (QCDR |pred|))
                         (AND (CONSP |ISTMP#1|)
                              (PROGN
                                (setq |pred1| (QCAR |ISTMP#1|))
                                'T))))
                  (AND (CONSP |pred|) (EQ (QCAR |pred|) '|or|)
                       (PROGN
                         (setq |ISTMP#1| (QCDR |pred|))
                         (AND (CONSP |ISTMP#1|)
                              (PROGN
                                (setq |pred1| (QCAR |ISTMP#1|))
                                'T)))))
              (|deepChaseInferences| |pred1| |$e|))
             ((OR (EQ |pred| 'T)
                  (AND (CONSP |pred|) (EQ (QCAR |pred|) 'NOT))
                  (AND (CONSP |pred|) (EQ (QCAR |pred|) '|not|)))
              |$e|)
             ('T (|chaseInferences| |pred| |$e|)))))))

;vectorLocation(op,sig) ==
;  u := or/[i for i in 1.. for u in $NRTdeltaList
;        | u is [=op,[='$,: xsig],:.] and sig=NRTsubstDelta(xsig) ]
;  u => $NRTdeltaLength - u + 6
;  nil    -- this signals that calls should be forwarded

(DEFUN |vectorLocation| (|op| |sig|)
  (PROG (|ISTMP#1| |ISTMP#2| |xsig| |u|)
  (declare (special |$NRTdeltaLength| |$NRTdeltaList|))
    (RETURN
      (SEQ (PROGN
             (setq |u|
                      (PROG (G167647)
                        (setq G167647 NIL)
                        (RETURN
                          (DO ((G167655 NIL G167647)
                               (|i| 1 (QSADD1 |i|))
                               (G167656 |$NRTdeltaList|
                                   (CDR G167656))
                               (|u| NIL))
                              ((OR G167655 (ATOM G167656)
                                   (PROGN
                                     (SETQ |u| (CAR G167656))
                                     NIL))
                               G167647)
                            (SEQ (EXIT (COND
                                         ((AND (CONSP |u|)
                                           (EQUAL (QCAR |u|) |op|)
                                           (PROGN
                                             (setq |ISTMP#1|
                                              (QCDR |u|))
                                             (AND (CONSP |ISTMP#1|)
                                              (PROGN
                                                (setq |ISTMP#2|
                                                 (QCAR |ISTMP#1|))
                                                (AND (CONSP |ISTMP#2|)
                                                 (EQUAL
                                                  (QCAR |ISTMP#2|) '$)
                                                 (PROGN
                                                   (setq |xsig|
                                                    (QCDR |ISTMP#2|))
                                                   'T)))))
                                           (BOOT-EQUAL |sig|
                                            (|NRTsubstDelta| |xsig|)))
                                          (SETQ G167647
                                           (OR G167647 |i|))))))))))
             (COND
               (|u| (+ (- |$NRTdeltaLength| |u|) 6))
               ('T NIL)))))))

;NRTsubstDelta(initSig) ==
;  sig := [replaceSlotTypes s for s in initSig] where
;     replaceSlotTypes(t) ==
;        atom t =>
;          not INTEGERP t => t
;          t = 0 => '$
;          t = 2 => '_$_$
;          t = 5 => $NRTaddForm
;          u:= $NRTdeltaList.($NRTdeltaLength+5-t)
;          CAR u = 'domain => CADR u
;          error "bad $NRTdeltaList entry"
;        MEMQ(CAR t,'(Mapping Union Record _:)) =>
;           [CAR t,:[replaceSlotTypes(x) for x in rest t]]
;        t

(DEFUN |NRTsubstDelta,replaceSlotTypes| (|t|)
  (PROG (|u|)
  (declare (special |$NRTdeltaLength| |$NRTdeltaList| |$NRTaddForm|))
    (RETURN
      (SEQ (IF (ATOM |t|)
               (EXIT (SEQ (IF (NULL (INTEGERP |t|)) (EXIT |t|))
                          (IF (EQL |t| 0) (EXIT '$))
                          (IF (EQL |t| 2) (EXIT '$$))
                          (IF (EQL |t| 5) (EXIT |$NRTaddForm|))
                          (setq |u|
                                   (ELT |$NRTdeltaList|
                                    (-
                                     (+ |$NRTdeltaLength| 5) |t|)))
                          (IF (BOOT-EQUAL (CAR |u|) '|domain|)
                              (EXIT (CADR |u|)))
                          (EXIT (|error| '|bad $NRTdeltaList entry|)))))
           (IF (member (CAR |t|) '(|Mapping| |Union| |Record| |:|))
               (EXIT (CONS (CAR |t|)
                           (PROG (G167677)
                             (setq G167677 NIL)
                             (RETURN
                               (DO ((G167682 (CDR |t|)
                                     (CDR G167682))
                                    (|x| NIL))
                                   ((OR (ATOM G167682)
                                     (PROGN
                                       (SETQ |x| (CAR G167682))
                                       NIL))
                                    (NREVERSE0 G167677))
                                 (SEQ (EXIT
                                       (SETQ G167677
                                        (CONS
                                         (|NRTsubstDelta,replaceSlotTypes|
                                          |x|)
                                         G167677))))))))))
           (EXIT |t|)))))

(DEFUN |NRTsubstDelta| (|initSig|)
  (PROG (|sig|)
    (RETURN
      (SEQ (setq |sig|
                    (PROG (G167698)
                      (setq G167698 NIL)
                      (RETURN
                        (DO ((G167703 |initSig| (CDR G167703))
                             (|s| NIL))
                            ((OR (ATOM G167703)
                                 (PROGN
                                   (SETQ |s| (CAR G167703))
                                   NIL))
                             (NREVERSE0 G167698))
                          (SEQ (EXIT (SETQ G167698
                                      (CONS
                                       (|NRTsubstDelta,replaceSlotTypes|
                                        |s|)
                                       G167698))))))))))))

;-----------------------------SLOT1 DATABASE------------------------------------
;updateSlot1DataBase [name,info] == HPUT($Slot1DataBase,name,info)

(DEFUN |updateSlot1DataBase| (G167714)
  (PROG (|name| |info|)
  (declare (special |$Slot1DataBase|))
    (RETURN
      (PROGN
        (setq |name| (CAR G167714))
        (setq |info| (CADR G167714))
        (HPUT |$Slot1DataBase| |name| |info|)))))

;NRTputInLocalReferences bod ==
;  $elt: local := ($QuickCode => 'QREFELT; 'ELT)
;  NRTputInHead bod

(DEFUN |NRTputInLocalReferences| (|bod|)
  (PROG (|$elt|)
    (DECLARE (SPECIAL |$elt| |$QuickCode|))
    (RETURN
      (PROGN
        (setq |$elt| (COND (|$QuickCode| 'QREFELT) ('T 'ELT)))
        (|NRTputInHead| |bod|)))))

\end{chunk}
\eject
\begin{thebibliography}{99}
\bibitem{1} nothing
\end{thebibliography}
\end{document}
