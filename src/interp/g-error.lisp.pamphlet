\documentclass{article}
\usepackage{axiom}
\begin{document}
\title{\$SPAD/src/interp g-error.lisp}
\author{The Axiom Team}
\maketitle
\begin{abstract}
\end{abstract}
\eject
\tableofcontents
\eject
<<*>>=
(IN-PACKAGE "BOOT" )

(SETANDFILEQ |$SystemError| '|SystemError|)

(SETANDFILEQ |$UserError| '|UserError|)

(SETANDFILEQ |$AlgebraError| '|AlgebraError|)

;-- REDERR is used in BFLOAT LISP, should be a macro
;-- REDERR msg == error msg
;-- BFLERRMSG func ==
;--  errorSupervisor($AlgebraError,STRCONC(
;--    '"BigFloat: invalid argument to ",func))
;argumentDataError(argnum, condit, funname) ==
;  msg := ['"The test",:bright pred2English condit,'"evaluates to",
;    :bright '"false",'%l,'"   for argument",:bright argnum,_
;    '"to the function",:bright funname,'"and this indicates",'%l,_
;    '"   that the argument is not appropriate."]
;  errorSupervisor($AlgebraError,msg)

(DEFUN |argumentDataError| (|argnum| |condit| |funname|)
  (PROG (|msg|)
    (DECLARE (SPECIAL |$AlgebraError|))
    (RETURN
      (PROGN
        (SPADLET |msg|
                 (CONS "The test"
                       (APPEND (|bright| (|pred2English| |condit|))
                               (CONS "evaluates to"
                                     (APPEND (|bright| "false")
                                      (CONS '|%l|
                                       (CONS "   for argument"
                                        (APPEND (|bright| |argnum|)
                                         (CONS "to the function"
                                          (APPEND (|bright| |funname|)
                                           (CONS "and this indicates"
                                            (CONS '|%l|
                                             (CONS
                                     "   that the argument is not appropriate."
                                              NIL)))))))))))))
        (|errorSupervisor| |$AlgebraError| |msg|)))))


;queryUser msg ==
;  -- display message and return reply
;  sayBrightly msg
;  READ_-LINE _*TERMINAL_-IO_*

(DEFUN |queryUser| (|msg|)
  (PROGN (|sayBrightly| |msg|) (|read-line| *TERMINAL-IO*)))

;-- errorSupervisor is the old style error message trapper
;errorSupervisor(errorType,errorMsg) ==
;  errorSupervisor1(errorType,errorMsg,$BreakMode)

(DEFUN |errorSupervisor| (|errorType| |errorMsg|)
  (DECLARE (SPECIAL |$BreakMode|))
  (|errorSupervisor1| |errorType| |errorMsg| |$BreakMode|))

;errorSupervisor1(errorType,errorMsg,$BreakMode) ==
;  $cclSystem and $BreakMode = 'trapNumerics =>
;    THROW('trapNumerics,$numericFailure)
;  BUMPCOMPERRORCOUNT()
;  errorLabel :=
;      errorType = $SystemError  => '"System error"
;      errorType = $UserError    => '"Apparent user error"
;      errorType = $AlgebraError =>
;        '"Error detected within library code"
;      STRINGP errorType         => errorType
;      '"Error with unknown classification"
;  msg :=
;    errorMsg is ['mathprint, :.] => errorMsg
;    not PAIRP errorMsg => ['"   ", errorMsg]
;    splitmsg := true
;    if MEMBER('%b,errorMsg) then splitmsg := nil
;      else if MEMBER('%d,errorMsg) then splitmsg := nil
;           else if MEMBER('%l,errorMsg) then splitmsg := nil
;    splitmsg => CDR [:['%l,'"   ",u] for u in errorMsg]
;    ['"   ",:errorMsg]
;  sayErrorly(errorLabel, msg)
;  handleLispBreakLoop($BreakMode)

(DEFUN |errorSupervisor1| (|errorType| |errorMsg| |$BreakMode|)
  (DECLARE (SPECIAL |$BreakMode|))
  (PROG (|errorLabel| |splitmsg| |msg|)
    (DECLARE (SPECIAL |$AlgebraError| |$UserError| |$SystemError|
                      |$cclSystem| |$numericFailure|))
    (RETURN
      (SEQ (COND
             ((AND |$cclSystem|
                   (BOOT-EQUAL |$BreakMode| '|trapNumerics|))
              (THROW '|trapNumerics| |$numericFailure|))
             ('T (BUMPCOMPERRORCOUNT)
              (SPADLET |errorLabel|
                       (COND
                         ((BOOT-EQUAL |errorType| |$SystemError|)
                          "System error")
                         ((BOOT-EQUAL |errorType| |$UserError|)
                          "Apparent user error")
                         ((BOOT-EQUAL |errorType| |$AlgebraError|)
                          "Error detected within library code")
                         ((STRINGP |errorType|) |errorType|)
                         ('T "Error with unknown classification")))
              (SPADLET |msg|
                       (COND
                         ((AND (PAIRP |errorMsg|)
                               (EQ (QCAR |errorMsg|) '|mathprint|))
                          |errorMsg|)
                         ((NULL (PAIRP |errorMsg|))
                          (CONS (MAKESTRING "   ")
                                (CONS |errorMsg| NIL)))
                         ('T (SPADLET |splitmsg| 'T)
                          (COND
                            ((|member| '|%b| |errorMsg|)
                             (SPADLET |splitmsg| NIL))
                            ((|member| '|%d| |errorMsg|)
                             (SPADLET |splitmsg| NIL))
                            ((|member| '|%l| |errorMsg|)
                             (SPADLET |splitmsg| NIL))
                            ('T NIL))
                          (COND
                            (|splitmsg|
                                (CDR (PROG (G166072)
                                       (SPADLET G166072 NIL)
                                       (RETURN
                                         (DO
                                          ((G166077 |errorMsg|
                                            (CDR G166077))
                                           (|u| NIL))
                                          ((OR (ATOM G166077)
                                            (PROGN
                                              (SETQ |u|
                                               (CAR G166077))
                                              NIL))
                                           G166072)
                                           (SEQ
                                            (EXIT
                                             (SETQ G166072
                                              (APPEND G166072
                                               (CONS '|%l|
                                                (CONS "   "
                                                 (CONS |u| NIL))))))))))))
                            ('T (CONS (MAKESTRING "   ") |errorMsg|))))))
              (|sayErrorly| |errorLabel| |msg|)
              (|handleLispBreakLoop| |$BreakMode|)))))))


;handleLispBreakLoop($BreakMode) ==
;  TERPRI()
;  -- The next line is to try to deal with some reported cases of unwanted
;  -- backtraces appearing, MCD.
;  ENABLE_-BACKTRACE(nil)
;  $BreakMode = 'break =>
;    sayBrightly '" "
;    BREAK()
;  $BreakMode = 'query =>
;    gotIt := nil
;    while not gotIt repeat
;      gotIt := true
;      msgQ :=
;       $cclSystem =>
;         ['%l,'"   You have two options. Enter:",'%l,_
;          '"    ",:bright '"top     ",'"  to return to top level, or",'%l,_
;          '"    ",:bright '"break   ",'"  to enter a LISP break loop.",'%l,_
;          '%l,'"   Please enter your choice now:"]
;       ['%l,'"   You have three options. Enter:",'%l,_
;        '"    ",:bright '"continue",'"  to continue processing,",'%l,_
;        '"    ",:bright '"top     ",'"  to return to top level, or",'%l,_
;        '"    ",:bright '"break   ",'"  to enter a LISP break loop.",'%l,_
;        '%l,'"   Please enter your choice now:"]
;      x := STRING2ID_-N(queryUser msgQ,1)
;      x :=
;        $cclSystem =>
;          selectOptionLC(x,'(top break),NIL)
;        selectOptionLC(x,'(top break continue),NIL)
;      null x =>
;        sayBrightly bright '"  That was not one of your choices!"
;        gotIt := NIL
;      x = 'top => returnToTopLevel()
;      x = 'break =>
;        $BreakMode := 'break
;        if not $cclSystem then
;          sayBrightly ['"   Enter",:bright '":C",
;            '"when you are ready to continue processing where you ",'%l,_
;            '"   interrupted the system, enter",:bright '"(TOP)",_
;            '"when you wish to return",'%l,'"   to top level.",'%l,'%l]
;        BREAK()
;      sayBrightly
;        '"   Processing will continue where it was interrupted."
;      THROW('SPAD__READER, nil)
;  $BreakMode = 'resume =>
;    returnToReader()
;  returnToTopLevel()

(DEFUN |handleLispBreakLoop| (|$BreakMode|)
  (DECLARE (SPECIAL |$BreakMode|))
  (PROG (|msgQ| |x| |gotIt|)
    (DECLARE (SPECIAL |$cclSystem|))
    (RETURN
      (SEQ (PROGN
             (TERPRI)
             (ENABLE-BACKTRACE NIL)
             (COND
               ((BOOT-EQUAL |$BreakMode| '|break|)
                (|sayBrightly| (MAKESTRING " ")) (BREAK))
               ((BOOT-EQUAL |$BreakMode| '|query|)
                (SPADLET |gotIt| NIL)
                (DO () ((NULL (NULL |gotIt|)) NIL)
                  (SEQ (EXIT (PROGN
                               (SPADLET |gotIt| 'T)
                               (SPADLET |msgQ|
                                        (COND
                                          (|$cclSystem|
                                           (CONS '|%l|
                                            (CONS
                                             "   You have two options. Enter:"
                                             (CONS '|%l|
                                              (CONS "    "
                                               (APPEND
                                                (|bright| "top     ")
                                                (CONS
                                                 "  to return to top level, or"
                                                 (CONS '|%l|
                                                  (CONS "    "
                                                   (APPEND
                                                    (|bright|
                                                     "break   ")
                                                    (CONS
                                                "  to enter a LISP break loop."
                                                     (CONS '|%l|
                                                      (CONS '|%l|
                                                       (CONS
                                             "   Please enter your choice now:"
                                                        NIL))))))))))))))
                                          ('T
                                           (CONS '|%l|
                                            (CONS
                                            "   You have three options. Enter:"
                                             (CONS '|%l|
                                              (CONS "    "
                                               (APPEND
                                                (|bright| "continue")
                                                (CONS
                                                 "  to continue processing,"
                                                 (CONS '|%l|
                                                  (CONS "    "
                                                   (APPEND
                                                    (|bright|
                                                     "top     ")
                                                    (CONS
                                                 "  to return to top level, or"
                                                     (CONS '|%l|
                                                      (CONS "    "
                                                       (APPEND
                                                        (|bright|
                                                         "break   ")
                                                        (CONS
                                                "  to enter a LISP break loop."
                                                         (CONS '|%l|
                                                          (CONS '|%l|
                                                           (CONS
                                             "   Please enter your choice now:"
                                                        NIL))))))))))))))))))))
                               (SPADLET |x|
                                        (STRING2ID-N
                                         (|queryUser| |msgQ|) 1))
                               (SPADLET |x|
                                        (COND
                                          (|$cclSystem|
                                           (|selectOptionLC| |x|
                                            '(|top| |break|) NIL))
                                          ('T
                                           (|selectOptionLC| |x|
                                            '(|top| |break| |continue|)
                                            NIL))))
                               (COND
                                 ((NULL |x|)
                                  (|sayBrightly|
                                      (|bright|
                                       "  That was not one of your choices!"))
                                  (SPADLET |gotIt| NIL))
                                 ((BOOT-EQUAL |x| '|top|)
                                  (|returnToTopLevel|))
                                 ((BOOT-EQUAL |x| '|break|)
                                  (SPADLET |$BreakMode| '|break|)
                                  (COND
                                    ((NULL |$cclSystem|)
                                     (|sayBrightly|
                                      (CONS "   Enter"
                                       (APPEND (|bright| ":C")
                                        (CONS
                         "when you are ready to continue processing where you "
                                         (CONS '|%l|
                                          (CONS
                                           "   interrupted the system, enter"
                                           (APPEND (|bright| "(TOP)")
                                            (CONS
                                             "when you wish to return"
                                             (CONS '|%l|
                                              (CONS "   to top level."
                                               (CONS '|%l|
                                                (CONS '|%l| NIL))))))))))))))
                                  (BREAK))
                                 ('T
                                  (|sayBrightly|
                       "   Processing will continue where it was interrupted.")
                                  (THROW 'SPAD_READER NIL))))))))
               ((BOOT-EQUAL |$BreakMode| '|resume|) (|returnToReader|))
               ('T (|returnToTopLevel|))))))))


;TOP() == returnToTopLevel()

(DEFUN TOP () (|returnToTopLevel|))

;returnToTopLevel() ==
;  SETQ(CHR, "ENDOFLINECHR")
;  SETQ(TOK, 'END__UNIT)
;  TOPLEVEL()

(DEFUN |returnToTopLevel| ()
  (PROGN (SETQ CHR 'ENDOFLINECHR) (SETQ TOK 'END_UNIT) (TOPLEVEL)))

;returnToReader() ==
;  ^$ReadingFile => returnToTopLevel()
;  sayBrightly ['"   Continuing to read the file...", '%l]
;  THROW('SPAD__READER, nil)

(DEFUN |returnToReader| ()
  (DECLARE (SPECIAL |$ReadingFile|))
  (COND
    ((NULL |$ReadingFile|) (|returnToTopLevel|))
    ('T
     (|sayBrightly|
         (CONS "   Continuing to read the file..." (CONS '|%l| NIL)))
     (THROW 'SPAD_READER NIL))))

;sayErrorly(errorLabel, msg) ==
;  $saturn => saturnSayErrorly(errorLabel, msg)
;  sayErrorly1(errorLabel, msg)

(DEFUN |sayErrorly| (|errorLabel| |msg|)
  (DECLARE (SPECIAL |$saturn|))
  (COND
    (|$saturn| (|saturnSayErrorly| |errorLabel| |msg|))
    ('T (|sayErrorly1| |errorLabel| |msg|))))

;saturnSayErrorly(errorLabel, msg) ==
;  _*STANDARD_-OUTPUT_* : fluid := $texOutputStream
;  old := pushSatOutput("line")
;  sayString '"\bgroup\color{red}"
;  sayString '"\begin{verbatim}"
;  sayErrorly1(errorLabel, msg)
;  sayString '"\end{verbatim}"
;  sayString '"\egroup"
;  popSatOutput(old)

(DEFUN |saturnSayErrorly| (|errorLabel| |msg|)
  (PROG (*STANDARD-OUTPUT* |old|)
    (DECLARE (SPECIAL *STANDARD-OUTPUT* |$texOutputStream|))
    (RETURN
      (PROGN
        (SPADLET *STANDARD-OUTPUT* |$texOutputStream|)
        (SPADLET |old| (|pushSatOutput| '|line|))
        (|sayString| (MAKESTRING "\\bgroup\\color{red}"))
        (|sayString| (MAKESTRING "\\begin{verbatim}"))
        (|sayErrorly1| |errorLabel| |msg|)
        (|sayString| (MAKESTRING "\\end{verbatim}"))
        (|sayString| (MAKESTRING "\\egroup"))
        (|popSatOutput| |old|)))))

;sayErrorly1(errorLabel, msg) ==
;  sayBrightly '" "
;  if $testingSystem then sayMSG $testingErrorPrefix
;  sayBrightly ['"   >> ",errorLabel,'":"]
;  m := msg
;  msg is ['mathprint, mathexpr] =>
;    mathprint mathexpr
;  sayBrightly msg

(DEFUN |sayErrorly1| (|errorLabel| |msg|)
  (PROG (|m| |ISTMP#1| |mathexpr|)
    (DECLARE (SPECIAL |$testingErrorPrefix|))
    (RETURN
      (PROGN
        (|sayBrightly| (MAKESTRING " "))
        (COND (|$testingSystem| (|sayMSG| |$testingErrorPrefix|)))
        (|sayBrightly|
            (CONS "   >> " (CONS |errorLabel| (CONS ":" NIL))))
        (SPADLET |m| |msg|)
        (COND
          ((AND (PAIRP |msg|) (EQ (QCAR |msg|) '|mathprint|)
                (PROGN
                  (SPADLET |ISTMP#1| (QCDR |msg|))
                  (AND (PAIRP |ISTMP#1|) (EQ (QCDR |ISTMP#1|) NIL)
                       (PROGN
                         (SPADLET |mathexpr| (QCAR |ISTMP#1|))
                         'T))))
           (|mathprint| |mathexpr|))
          ('T (|sayBrightly| |msg|)))))))

;-- systemError is being phased out. Please use keyedSystemError.
;systemError(:x) == errorSupervisor($SystemError,IFCAR x)

(DEFUN |systemError| (&REST G166161 &AUX |x|)
  (DECLARE (SPECIAL |$SystemError|))
  (DSETQ |x| G166161)
  (|errorSupervisor| |$SystemError| (IFCAR |x|)))

;-- unexpectedSystemError() ==
;--  systemError '"Oh, no.  Unexpected internal error."
;userError x == errorSupervisor($UserError,x)

(DEFUN |userError| (|x|)
  (DECLARE (SPECIAL |$UserError|))
  (|errorSupervisor| |$UserError| |x|))

;error(x) == errorSupervisor($AlgebraError,x)

(DEFUN |error| (|x|)
  (DECLARE (SPECIAL |$AlgebraError|))
  (|errorSupervisor| |$AlgebraError| |x|))

;IdentityError(op) ==
;    error(["No identity element for reduce of empty list using operation",op])

(DEFUN |IdentityError| (|op|)
 (|error| (CONS '|No identity element for reduce of empty list using operation|
                 (CONS |op| NIL))))

;throwMessage(:msg) ==
;  if $compilingMap then clearCache $mapName
;  msg' := mkMessage concatList msg
;  sayMSG msg'
;  if $printMsgsToFile then sayMSG2File msg'
;  spadThrow()

(DEFUN |throwMessage| (&REST G166176 &AUX |msg|)
  (DSETQ |msg| G166176)
  (PROG (|msg'|)
    (DECLARE (SPECIAL |$printMsgsToFile| |$mapName| |$compilingMap|))
    (RETURN
      (PROGN
        (COND (|$compilingMap| (|clearCache| |$mapName|)))
        (SPADLET |msg'| (|mkMessage| (|concatList| |msg|)))
        (|sayMSG| |msg'|)
        (COND (|$printMsgsToFile| (|sayMSG2File| |msg'|)))
        (|spadThrow|)))))

@
\eject
\begin{thebibliography}{99}
\bibitem{1} nothing
\end{thebibliography}
\end{document}
