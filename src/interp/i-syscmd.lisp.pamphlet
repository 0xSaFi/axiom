\documentclass{article}
\usepackage{axiom}
\begin{document}
\title{\$SPAD/src/interp i-syscmd.lisp}
\author{The Axiom Team}
\maketitle
\begin{abstract}
\end{abstract}
\eject
\tableofcontents
\eject
<<*>>=

(IN-PACKAGE "BOOT" )

;SETANDFILEQ($errorReportLevel,'warning)

(SETANDFILEQ |$errorReportLevel| (QUOTE |warning|)) 

;SETANDFILEQ($sourceFileTypes,'(INPUT SPAD BOOT LISP LISP370 META))

(SETANDFILEQ |$sourceFileTypes| (QUOTE (INPUT SPAD BOOT LISP LISP370 META))) 

;SETANDFILEQ($countAssoc,'( (cache countCache) ))

(SETANDFILEQ |$countAssoc| (QUOTE ((|cache| |countCache|)))) 

;--% Top level system command
;-- (mapcar #'car $systemCommands)
;initializeSystemCommands() ==
;  l := $systemCommands
;  $SYSCOMMANDS := NIL
;  while l repeat
;    $SYSCOMMANDS := CONS(CAAR l, $SYSCOMMANDS)
;    l := CDR l
;  $SYSCOMMANDS := NREVERSE $SYSCOMMANDS

(DEFUN |initializeSystemCommands| ()
  (PROG (|l|)
  (declare (special $SYSCOMMANDS |$systemCommands|))
    (RETURN
      (SEQ (PROGN
             (SPADLET |l| |$systemCommands|)
             (SPADLET $SYSCOMMANDS NIL)
             (DO () ((NULL |l|) NIL)
               (SEQ (EXIT (PROGN
                            (SPADLET $SYSCOMMANDS
                                     (CONS (CAAR |l|) $SYSCOMMANDS))
                            (SPADLET |l| (CDR |l|))))))
             (SPADLET $SYSCOMMANDS (NREVERSE $SYSCOMMANDS)))))))

;synonymsForUserLevel l ==
;  -- l is a list of synonyms, and this returns a sublist of applicable
;  -- synonyms at the current user level.
;  $UserLevel = 'development => l
;  nl := NIL
;  for syn in reverse l repeat
;    cmd := STRING2ID_-N(CDR syn,1)
;    null selectOptionLC(cmd,commandsForUserLevel
;      $systemCommands,NIL) => nil
;    nl := [syn,:nl]
;  nl

(DEFUN |synonymsForUserLevel| (|l|)
  (PROG (|cmd| |nl|)
  (declare (special |$systemCommands| |$UserLevel|))
    (RETURN
      (SEQ (COND
             ((BOOT-EQUAL |$UserLevel| '|development|) |l|)
             ('T (SPADLET |nl| NIL)
              (DO ((G166131 (REVERSE |l|) (CDR G166131))
                   (|syn| NIL))
                  ((OR (ATOM G166131)
                       (PROGN (SETQ |syn| (CAR G166131)) NIL))
                   NIL)
                (SEQ (EXIT (PROGN
                             (SPADLET |cmd|
                                      (STRING2ID-N (CDR |syn|) 1))
                             (COND
                               ((NULL (|selectOptionLC| |cmd|
                                       (|commandsForUserLevel|
                                        |$systemCommands|)
                                       NIL))
                                NIL)
                               ('T (SPADLET |nl| (CONS |syn| |nl|))))))))
              |nl|))))))

;--% Utility for access to original command line
;getSystemCommandLine() ==
;  p := STRPOS('")",$currentLine,0,NIL)
;  line := if p then SUBSTRING($currentLine,p,NIL) else $currentLine
;  maxIndex:= MAXINDEX line
;  for i in 0..maxIndex while (line.i^=" ") repeat index:= i
;  if index=maxIndex then line := '""
;  else line := SUBSTRING(line,index+2,nil)
;  line

(DEFUN |getSystemCommandLine| ()
  (PROG (|p| |maxIndex| |index| |line|)
  (declare (special |$currentLine|))
    (RETURN
      (SEQ (PROGN
             (SPADLET |p|
                      (STRPOS (MAKESTRING ")") |$currentLine| 0 NIL))
             (SPADLET |line|
                      (COND
                        (|p| (SUBSTRING |$currentLine| |p| NIL))
                        ('T |$currentLine|)))
             (SPADLET |maxIndex| (MAXINDEX |line|))
             (DO ((|i| 0 (QSADD1 |i|)))
                 ((OR (QSGREATERP |i| |maxIndex|)
                      (NULL (NEQUAL (ELT |line| |i|) '| |)))
                  NIL)
               (SEQ (EXIT (SPADLET |index| |i|))))
             (COND
               ((BOOT-EQUAL |index| |maxIndex|)
                (SPADLET |line| (MAKESTRING "")))
               ('T
                (SPADLET |line|
                         (SUBSTRING |line| (PLUS |index| 2) NIL))))
             |line|)))))

;--% )load
;load args == loadSpad2Cmd args

(DEFUN |load| (|args|) (|loadSpad2Cmd| |args|)) 

;loadSpad2Cmd args ==
;    sayKeyedMsg("S2IU0003", nil)
;    NIL

(DEFUN |loadSpad2Cmd| (|args|)
 (declare (ignore |args|))
 (PROGN (|sayKeyedMsg| (QUOTE S2IU0003) NIL) NIL)) 

;--  load1(args,$forceDatabaseUpdate)
;--load1(args,$forceDatabaseUpdate) ==  -- $ var is now local
;--  null args => helpSpad2Cmd '(load)
;--  loadfun := 'loadLib
;--  justWondering := nil
;--  compiler := 'old
;--  doExpose := true
;--  $forceDatabaseUpdate := true  -- BMT request, 5/14/90
;--  for [opt,:.] in $options repeat
;--    fullopt := selectOptionLC(opt,
;--      '(cond update query new noexpose noupdate),
;--        'optionError)
;--    fullopt = 'cond     => loadfun := 'loadLibIfNotLoaded
;--    fullopt = 'query    => justWondering := true
;--    fullopt = 'update   => $forceDatabaseUpdate := true
;--    fullopt = 'noexpose => doExpose := false
;--    fullopt = 'noupdate => $forceDatabaseUpdate := false
;--  if $forceDatabaseUpdate then clearClams()
;--  for lib in args repeat
;--    lib := object2Identifier lib
;--    justWondering =>
;--      GET(lib,'LOADED) => sayKeyedMsg("S2IZ0028",[lib])
;--      sayKeyedMsg("S2IZ0029",[lib])
;--    null GETDATABASE(lib,'OBJECT) and
;--     null (lib := GETDATABASE(lib,'CONSTRUCTOR)) =>
;--      sayKeyedMsg("S2IL0020", [namestring [lib,$spadLibFT,"*"]])
;--    null FUNCALL(loadfun,lib) =>
;--      sayKeyedMsg("S2IZ0029",[lib])
;--    sayKeyedMsg("S2IZ0028",[lib])
;--    if doExpose and
;--       not isExposedConstructor(lib) then
;--          setExposeAddConstr([lib])
;--  'EndOfLoad
;reportCount () ==
;  centerAndHighlight(" Current Count Settings ",$LINELENGTH,specialChar 'hbar)
;  SAY " "
;  sayBrightly [:bright " cache",fillerSpaces(30,'".")," ",$cacheCount]
;  if $cacheAlist then
;    for [a,:b] in $cacheAlist repeat
;      aPart:= linearFormatName a
;      n:= sayBrightlyLength aPart
;      sayBrightly concat("     ",aPart," ",fillerSpaces(32-n,'".")," ",b)
;  SAY " "
;  sayBrightly [:bright " stream",fillerSpaces(29,'".")," ",$streamCount]

(DEFUN |reportCount| ()
  (PROG (|a| |b| |aPart| |n|)
  (declare (special |$streamCount| |$cacheAlist| |$cacheCount| $LINELENGTH))
    (RETURN
      (SEQ (PROGN
             (|centerAndHighlight| '| Current Count Settings |
                 $LINELENGTH (|specialChar| '|hbar|))
             (SAY (MAKESTRING " "))
             (|sayBrightly|
                 (APPEND (|bright| '| cache|)
                         (CONS (|fillerSpaces| 30 (MAKESTRING "."))
                               (CONS '| | (CONS |$cacheCount| NIL)))))
             (COND
               (|$cacheAlist|
                   (DO ((G166567 |$cacheAlist| (CDR G166567))
                        (G166555 NIL))
                       ((OR (ATOM G166567)
                            (PROGN
                              (SETQ G166555 (CAR G166567))
                              NIL)
                            (PROGN
                              (PROGN
                                (SPADLET |a| (CAR G166555))
                                (SPADLET |b| (CDR G166555))
                                G166555)
                              NIL))
                        NIL)
                     (SEQ (EXIT (PROGN
                                  (SPADLET |aPart|
                                           (|linearFormatName| |a|))
                                  (SPADLET |n|
                                           (|sayBrightlyLength|
                                            |aPart|))
                                  (|sayBrightly|
                                      (|concat| '|     | |aPart| '| |
                                       (|fillerSpaces|
                                        (SPADDIFFERENCE 32 |n|)
                                        (MAKESTRING "."))
                                       '| | |b|))))))))
             (SAY (MAKESTRING " "))
             (|sayBrightly|
                 (APPEND (|bright| '| stream|)
                         (CONS (|fillerSpaces| 29 (MAKESTRING "."))
                               (CONS '| | (CONS |$streamCount| NIL))))))))))

;reportOperations(oldArg,u) ==
;  -- u might be an uppercased version of oldArg
;  $env:local := [[NIL]]
;  $eval:local := true           --generate code-- don't just type analyze
;  $genValue:local := true       --evaluate all generated code
;  null u => nil
;  $doNotAddEmptyModeIfTrue: local:= true
;  u = $quadSymbol =>
;     sayBrightly ['"   mode denotes", :bright '"any", "type"]
;  u = "%" =>
;    sayKeyedMsg("S2IZ0063",NIL)
;    sayKeyedMsg("S2IZ0064",NIL)
;  u isnt ['Record,:.] and u isnt ['Union,:.] and
;    null(isNameOfType u) and u isnt ['typeOf,.] =>
;      if ATOM oldArg then oldArg := [oldArg]
;      sayKeyedMsg("S2IZ0063",NIL)
;      for op in oldArg repeat
;        sayKeyedMsg("S2IZ0062",[opOf op])
;  (v := isDomainValuedVariable u) =>  reportOpsFromUnitDirectly0 v
;  unitForm:=
;    atom u => opOf unabbrev u
;    unabbrev u
;  atom unitForm => reportOpsFromLisplib0(unitForm,u)
;  unitForm' := evaluateType unitForm
;  tree := mkAtree removeZeroOneDestructively unitForm
;  (unitForm' := isType tree) => reportOpsFromUnitDirectly0 unitForm'
;  sayKeyedMsg("S2IZ0041",[unitForm])

;(DEFUN |reportOperations| (|oldArg| |u|)
;  (PROG (|$env| |$eval| |$genValue| |$doNotAddEmptyModeIfTrue|
;                |ISTMP#1| |v| |unitForm| |tree| |unitForm'|)
;    (DECLARE (SPECIAL |$env| |$eval| |$genValue| |$quadSymbol|
;                      |$doNotAddEmptyModeIfTrue|))
;    (RETURN
;      (SEQ (PROGN
;             (SPADLET |$env| (CONS (CONS NIL NIL) NIL))
;             (SPADLET |$eval| 'T)
;             (SPADLET |$genValue| 'T)
;             (COND
;               ((NULL |u|) NIL)
;               ('T (SPADLET |$doNotAddEmptyModeIfTrue| 'T)
;                (COND
;                  ((BOOT-EQUAL |u| |$quadSymbol|)
;                   (|sayBrightly|
;                       (CONS (MAKESTRING "   mode denotes")
;                             (APPEND (|bright| (MAKESTRING "any"))
;                                     (CONS '|type| NIL)))))
;                  ((BOOT-EQUAL |u| '%) (|sayKeyedMsg| 'S2IZ0063 NIL)
;                   (|sayKeyedMsg| 'S2IZ0064 NIL))
;                  ((AND (NULL (AND (PAIRP |u|)
;                                   (EQ (QCAR |u|) '|Record|)))
;                        (NULL (AND (PAIRP |u|)
;                                   (EQ (QCAR |u|) '|Union|)))
;                        (NULL (|isNameOfType| |u|))
;                        (NULL (AND (PAIRP |u|)
;                                   (EQ (QCAR |u|) '|typeOf|)
;                                   (PROGN
;                                     (SPADLET |ISTMP#1| (QCDR |u|))
;                                     (AND (PAIRP |ISTMP#1|)
;                                      (EQ (QCDR |ISTMP#1|) NIL))))))
;                   (COND
;                     ((ATOM |oldArg|)
;                      (SPADLET |oldArg| (CONS |oldArg| NIL))))
;                   (|sayKeyedMsg| 'S2IZ0063 NIL)
;                   (DO ((G166662 |oldArg| (CDR G166662))
;                        (|op| NIL))
;                       ((OR (ATOM G166662)
;                            (PROGN (SETQ |op| (CAR G166662)) NIL))
;                        NIL)
;                     (SEQ (EXIT (|sayKeyedMsg| 'S2IZ0062
;                                    (CONS (|opOf| |op|) NIL))))))
;                  ((SPADLET |v| (|isDomainValuedVariable| |u|))
;                   (|reportOpsFromUnitDirectly0| |v|))
;                  ('T
;                   (SPADLET |unitForm|
;                            (COND
;                              ((ATOM |u|) (|opOf| (|unabbrev| |u|)))
;                              ('T (|unabbrev| |u|))))
;                   (COND
;                     ((ATOM |unitForm|)
;                      (|reportOpsFromLisplib0| |unitForm| |u|))
;                     ('T
;                      (SPADLET |unitForm'| (|evaluateType| |unitForm|))
;                      (SPADLET |tree|
;                               (|mkAtree|
;                                   (|removeZeroOneDestructively|
;                                    |unitForm|)))
;                      (COND
;                        ((SPADLET |unitForm'| (|isType| |tree|))
;                         (|reportOpsFromUnitDirectly0| |unitForm'|))
;                        ('T
;                         (|sayKeyedMsg| 'S2IZ0041
;                             (CONS |unitForm| NIL)))))))))))))))

;reportOpsFromUnitDirectly0 D ==
;  $useEditorForShowOutput =>
;    reportOpsFromUnitDirectly1 D
;  reportOpsFromUnitDirectly D

;reportOpsFromUnitDirectly1 D ==
;  showFile := pathname ['SHOW,'LISTING,$listingDirectory]
;  _$ERASE showFile
;  $sayBrightlyStream : fluid :=
;    DEFIOSTREAM([['FILE,:showFile], '(MODE . OUTPUT)],255,0)
;  sayShowWarning()
;  reportOpsFromUnitDirectly D
;  SHUT $sayBrightlyStream
;  editFile showFile

;(DEFUN |reportOpsFromUnitDirectly1| (D)
;  (PROG (|$sayBrightlyStream| |showFile|)
;    (DECLARE (SPECIAL |$sayBrightlyStream| $ERASE |$listingDirectory|))
;    (RETURN
;      (PROGN
;        (SPADLET |showFile|
;                 (|pathname|
;                     (CONS 'SHOW
;                           (CONS 'LISTING
;                                 (CONS |$listingDirectory| NIL)))))
;        ($ERASE |showFile|)
;        (SPADLET |$sayBrightlyStream|
;                 (DEFIOSTREAM
;                     (CONS (CONS 'FILE |showFile|)
;                           (CONS '(MODE . OUTPUT) NIL))
;                     255 0))
;        (|sayShowWarning|)
;        (|reportOpsFromUnitDirectly| D)
;        (SHUT |$sayBrightlyStream|)
;        (|editFile| |showFile|)))))

;sayShowWarning() ==
;  sayBrightly
;    '"Warning: this is a temporary file and will be deleted the next"
;  sayBrightly
;    '"         time you use )show. Rename it and FILE if you wish to"
;  sayBrightly
;    '"         save the contents."
;  sayBrightly '""

;(DEFUN |sayShowWarning| ()
;  (PROGN
;    (|sayBrightly|
;        (MAKESTRING
;            "Warning: this is a temporary file and will be deleted the next"))
;    (|sayBrightly|
;        (MAKESTRING
;            "         time you use )show. Rename it and FILE if you wish to"))
;    (|sayBrightly| (MAKESTRING "         save the contents."))
;    (|sayBrightly| (MAKESTRING ""))))

;reportOpsFromLisplib0(unitForm,u)  ==
;  $useEditorForShowOutput => reportOpsFromLisplib1(unitForm,u)
;  reportOpsFromLisplib(unitForm,u)

;(DEFUN |reportOpsFromLisplib0| (|unitForm| |u|)
;  (declare (special |$useEditorForShowOutput|))
;  (COND
;    (|$useEditorForShowOutput|
;        (|reportOpsFromLisplib1| |unitForm| |u|))
;    ('T (|reportOpsFromLisplib| |unitForm| |u|))))

;reportOpsFromLisplib1(unitForm,u)  ==
;  showFile := pathname ['SHOW,'LISTING,$listingDirectory]
;  _$ERASE showFile
;  $sayBrightlyStream : fluid :=
;    DEFIOSTREAM([['FILE,:showFile], '(MODE . OUTPUT)],255,0)
;  sayShowWarning()
;  reportOpsFromLisplib(unitForm,u)
;  SHUT $sayBrightlyStream
;  editFile showFile

;(DEFUN |reportOpsFromLisplib1| (|unitForm| |u|)
;  (PROG (|$sayBrightlyStream| |showFile|)
;    (DECLARE (SPECIAL |$sayBrightlyStream| $ERASE |$listingDirectory|))
;    (RETURN
;      (PROGN
;        (SPADLET |showFile|
;                 (|pathname|
;                     (CONS 'SHOW
;                           (CONS 'LISTING
;                                 (CONS |$listingDirectory| NIL)))))
;        ($ERASE |showFile|)
;        (SPADLET |$sayBrightlyStream|
;                 (DEFIOSTREAM
;                     (CONS (CONS 'FILE |showFile|)
;                           (CONS '(MODE . OUTPUT) NIL))
;                     255 0))
;        (|sayShowWarning|)
;        (|reportOpsFromLisplib| |unitForm| |u|)
;        (SHUT |$sayBrightlyStream|)
;        (|editFile| |showFile|)))))

;reportOpsFromUnitDirectly unitForm ==
;  isRecordOrUnion := unitForm is [a,:.] and a in '(Record Union)
;  unit:= evalDomain unitForm
;  top:= CAR unitForm
;  kind:= GETDATABASE(top,'CONSTRUCTORKIND)
;  sayBrightly concat('%b,formatOpType unitForm,
;    '%d,'"is a",'%b,kind,'%d, '"constructor.")
;  if not isRecordOrUnion then
;    abb := GETDATABASE(top,'ABBREVIATION)
;    sourceFile := GETDATABASE(top,'SOURCEFILE)
;    sayBrightly ['" Abbreviation for",:bright top,'"is",:bright abb]
;    verb :=
;      isExposedConstructor top => '"is"
;      '"is not"
;    sayBrightly ['" This constructor",:bright verb,
;      '"exposed in this frame."]
;    sayBrightly ['" Issue",:bright STRCONC('")edit ",
;      namestring sourceFile),'"to see algebra source code for",
;        :bright abb,'%l]
;  for [opt] in $options repeat
;    opt := selectOptionLC(opt,$showOptions,'optionError)
;    opt = 'attributes =>
;      centerAndHighlight('"Attributes",$LINELENGTH,specialChar 'hbar)
;      isRecordOrUnion =>
;        sayBrightly '"   Records and Unions have no attributes."
;      sayBrightly '""
;      attList:= REMDUP MSORT [x for [x,:.] in unit.2]
;      say2PerLine [formatAttribute x for x in attList]
;      NIL
;    opt = 'operations =>
;      $commentedOps: local := 0
;      --new form is (<op> <signature> <slotNumber> <condition> <kind>)
;      centerAndHighlight('"Operations",$LINELENGTH,specialChar 'hbar)
;      sayBrightly '""
;      if isRecordOrUnion
;        then
;          constructorFunction:= GET(top,"makeFunctionList") or
;            systemErrorHere '"reportOpsFromUnitDirectly"
;          [funlist,.]:= FUNCALL(constructorFunction,"$",unitForm,
;            $CategoryFrame)
;          sigList := REMDUP MSORT [[[a,b],true,[c,0,1]] for
;            [a,b,c] in funlist]
;        else
;          sigList:= REMDUP MSORT getOplistForConstructorForm unitForm
;      say2PerLine [formatOperation(x,unit) for x in sigList]
;      if $commentedOps ^= 0 then
;        sayBrightly
;          ['"Functions that are not yet implemented are preceded by",
;            :bright '"--"]
;      sayBrightly '""
;  NIL

(DEFUN |reportOpsFromUnitDirectly| (|unitForm|)
  (PROG (|$commentedOps| |isRecordOrUnion| |unit| |top| |kind| |abb|
            |sourceFile| |verb| |opt| |x| |attList|
            |constructorFunction| |LETTMP#1| |funlist| |a| |b| |c|
            |sigList|)
    (DECLARE (SPECIAL |$commentedOps| |$CategoryFrame| $LINELENGTH |$options|
                      |$showOptions|))
    (RETURN
      (SEQ (PROGN
             (SPADLET |isRecordOrUnion|
                      (AND (PAIRP |unitForm|)
                           (PROGN (SPADLET |a| (QCAR |unitForm|)) 'T)
                           (|member| |a| '(|Record| |Union|))))
             (SPADLET |unit| (|evalDomain| |unitForm|))
             (SPADLET |top| (CAR |unitForm|))
             (SPADLET |kind| (GETDATABASE |top| 'CONSTRUCTORKIND))
             (|sayBrightly|
                 (|concat| '|%b| (|formatOpType| |unitForm|) '|%d|
                     (MAKESTRING "is a") '|%b| |kind| '|%d|
                     (MAKESTRING "constructor.")))
             (COND
               ((NULL |isRecordOrUnion|)
                (SPADLET |abb| (GETDATABASE |top| 'ABBREVIATION))
                (SPADLET |sourceFile| (GETDATABASE |top| 'SOURCEFILE))
                (|sayBrightly|
                    (CONS (MAKESTRING " Abbreviation for")
                          (APPEND (|bright| |top|)
                                  (CONS (MAKESTRING "is")
                                        (|bright| |abb|)))))
                (SPADLET |verb|
                         (COND
                           ((|isExposedConstructor| |top|)
                            (MAKESTRING "is"))
                           ('T (MAKESTRING "is not"))))
                (|sayBrightly|
                    (CONS (MAKESTRING " This constructor")
                          (APPEND (|bright| |verb|)
                                  (CONS (MAKESTRING
                                         "exposed in this frame.")
                                        NIL))))
                (|sayBrightly|
                    (CONS (MAKESTRING " Issue")
                          (APPEND (|bright|
                                      (STRCONC (MAKESTRING ")edit ")
                                       (|namestring| |sourceFile|)))
                                  (CONS (MAKESTRING
                                         "to see algebra source code for")
                                        (APPEND (|bright| |abb|)
                                         (CONS '|%l| NIL))))))))
             (DO ((G166753 |$options| (CDR G166753))
                  (G166737 NIL))
                 ((OR (ATOM G166753)
                      (PROGN (SETQ G166737 (CAR G166753)) NIL)
                      (PROGN
                        (PROGN
                          (SPADLET |opt| (CAR G166737))
                          G166737)
                        NIL))
                  NIL)
               (SEQ (EXIT (PROGN
                            (SPADLET |opt|
                                     (|selectOptionLC| |opt|
                                      |$showOptions| '|optionError|))
                            (COND
                              ((BOOT-EQUAL |opt| '|attributes|)
                               (|centerAndHighlight|
                                   (MAKESTRING "Attributes")
                                   $LINELENGTH (|specialChar| '|hbar|))
                               (COND
                                 (|isRecordOrUnion|
                                     (|sayBrightly|
                                      (MAKESTRING
                                 "   Records and Unions have no attributes.")))
                                 ('T (|sayBrightly| (MAKESTRING ""))
                                  (SPADLET |attList|
                                           (REMDUP
                                            (MSORT
                                             (PROG (G166765)
                                               (SPADLET G166765 NIL)
                                               (RETURN
                                                 (DO
                                                  ((G166771
                                                    (ELT |unit| 2)
                                                    (CDR G166771))
                                                   (G166720 NIL))
                                                  ((OR (ATOM G166771)
                                                    (PROGN
                                                      (SETQ G166720
                                                       (CAR G166771))
                                                      NIL)
                                                    (PROGN
                                                      (PROGN
                                                        (SPADLET |x|
                                                         (CAR
                                                          G166720))
                                                        G166720)
                                                      NIL))
                                                   (NREVERSE0
                                                    G166765))
                                                   (SEQ
                                                    (EXIT
                                                     (SETQ G166765
                                                      (CONS |x|
                                                       G166765))))))))))
                                  (|say2PerLine|
                                      (PROG (G166782)
                                        (SPADLET G166782 NIL)
                                        (RETURN
                                          (DO
                                           ((G166787 |attList|
                                             (CDR G166787))
                                            (|x| NIL))
                                           ((OR (ATOM G166787)
                                             (PROGN
                                               (SETQ |x|
                                                (CAR G166787))
                                               NIL))
                                            (NREVERSE0 G166782))
                                            (SEQ
                                             (EXIT
                                              (SETQ G166782
                                               (CONS
                                                (|formatAttribute| |x|)
                                                G166782))))))))
                                  NIL)))
                              ((BOOT-EQUAL |opt| '|operations|)
                               (SPADLET |$commentedOps| 0)
                               (|centerAndHighlight|
                                   (MAKESTRING "Operations")
                                   $LINELENGTH (|specialChar| '|hbar|))
                               (|sayBrightly| (MAKESTRING ""))
                               (COND
                                 (|isRecordOrUnion|
                                     (SPADLET |constructorFunction|
                                      (OR
                                       (GETL |top| '|makeFunctionList|)
                                       (|systemErrorHere|
                                        (MAKESTRING
                                         "reportOpsFromUnitDirectly"))))
                                     (SPADLET |LETTMP#1|
                                      (FUNCALL |constructorFunction| '$
                                       |unitForm| |$CategoryFrame|))
                                     (SPADLET |funlist|
                                      (CAR |LETTMP#1|))
                                     (SPADLET |sigList|
                                      (REMDUP
                                       (MSORT
                                        (PROG (G166798)
                                          (SPADLET G166798 NIL)
                                          (RETURN
                                            (DO
                                             ((G166804 |funlist|
                                               (CDR G166804))
                                              (G166729 NIL))
                                             ((OR (ATOM G166804)
                                               (PROGN
                                                 (SETQ G166729
                                                  (CAR G166804))
                                                 NIL)
                                               (PROGN
                                                 (PROGN
                                                   (SPADLET |a|
                                                    (CAR G166729))
                                                   (SPADLET |b|
                                                    (CADR G166729))
                                                   (SPADLET |c|
                                                    (CADDR G166729))
                                                   G166729)
                                                 NIL))
                                              (NREVERSE0 G166798))
                                              (SEQ
                                               (EXIT
                                                (SETQ G166798
                                                 (CONS
                                                  (CONS
                                                   (CONS |a|
                                                    (CONS |b| NIL))
                                                   (CONS 'T
                                                    (CONS
                                                     (CONS |c|
                                                      (CONS 0
                                                       (CONS 1 NIL)))
                                                     NIL)))
                                                  G166798)))))))))))
                                 ('T
                                  (SPADLET |sigList|
                                           (REMDUP
                                            (MSORT
                                             (|getOplistForConstructorForm|
                                              |unitForm|))))))
                               (|say2PerLine|
                                   (PROG (G166815)
                                     (SPADLET G166815 NIL)
                                     (RETURN
                                       (DO
                                        ((G166820 |sigList|
                                          (CDR G166820))
                                         (|x| NIL))
                                        ((OR (ATOM G166820)
                                          (PROGN
                                            (SETQ |x| (CAR G166820))
                                            NIL))
                                         (NREVERSE0 G166815))
                                         (SEQ
                                          (EXIT
                                           (SETQ G166815
                                            (CONS
                                             (|formatOperation| |x|
                                              |unit|)
                                             G166815))))))))
                               (COND
                                 ((NEQUAL |$commentedOps| 0)
                                  (|sayBrightly|
                                      (CONS
                                       (MAKESTRING
                      "Functions that are not yet implemented are preceded by")
                                       (|bright| (MAKESTRING "--"))))))
                               (|sayBrightly| (MAKESTRING ""))))))))
             NIL)))))

;reportOpsFromLisplib(op,u) ==
;  null(fn:= constructor? op) => sayKeyedMsg("S2IZ0054",[u])
;  argml :=
;    (s := getConstructorSignature op) => KDR s
;    NIL
;  typ:= GETDATABASE(op,'CONSTRUCTORKIND)
;  nArgs:= #argml
;  argList:= KDR GETDATABASE(op,'CONSTRUCTORFORM)
;  functorForm:= [op,:argList]
;  argml:= EQSUBSTLIST(argList,$FormalMapVariableList,argml)
;  functorFormWithDecl:= [op,:[[":",a,m] for a in argList for m in argml]]
;  sayBrightly concat(bright form2StringWithWhere functorFormWithDecl,
;                     '" is a",bright typ,'"constructor")
;  sayBrightly ['" Abbreviation for",:bright op,'"is",:bright fn]
;  verb :=
;    isExposedConstructor op => '"is"
;    '"is not"
;  sayBrightly ['" This constructor",:bright verb,
;    '"exposed in this frame."]
;  sourceFile := GETDATABASE(op,'SOURCEFILE)
;  sayBrightly ['" Issue",:bright STRCONC('")edit ",
;    namestring sourceFile),
;      '"to see algebra source code for",:bright fn,'%l]
;  for [opt] in $options repeat
;    opt := selectOptionLC(opt,$showOptions,'optionError)
;    opt = 'layout =>
;      dc1 fn
;    opt = 'views => sayBrightly ['"To get",:bright '"views",
;      '"you must give parameters of constructor"]
;    opt = 'attributes =>
;      centerAndHighlight('"Attributes",$LINELENGTH,specialChar 'hbar)
;      sayBrightly '""
;      attList:= REMDUP MSORT [x for [x,:.] in
;        GETDATABASE(op,'ATTRIBUTES)]
;      null attList => sayBrightly
;        concat('%b,form2String functorForm,'%d,"has no attributes.",'%l)
;      say2PerLine [formatAttribute x for x in attList]
;      NIL
;    opt = 'operations => displayOperationsFromLisplib functorForm
;    nil

(DEFUN |reportOpsFromLisplib| (|op| |u|)
  (PROG (|fn| |s| |typ| |nArgs| |argList| |functorForm| |argml|
              |functorFormWithDecl| |verb| |sourceFile| |opt| |x| |attList|)
  (declare (special $LINELENGTH |$showOptions| |$options|
                    |$FormalMapVariableList|))
    (RETURN
      (SEQ (COND
             ((NULL (SPADLET |fn| (|constructor?| |op|)))
              (|sayKeyedMsg| 'S2IZ0054 (CONS |u| NIL)))
             ('T
              (SPADLET |argml|
                       (COND
                         ((SPADLET |s|
                                   (|getConstructorSignature| |op|))
                          (KDR |s|))
                         ('T NIL)))
              (SPADLET |typ| (GETDATABASE |op| 'CONSTRUCTORKIND))
              (SPADLET |nArgs| (|#| |argml|))
              (SPADLET |argList|
                       (KDR (GETDATABASE |op| 'CONSTRUCTORFORM)))
              (SPADLET |functorForm| (CONS |op| |argList|))
              (SPADLET |argml|
                       (EQSUBSTLIST |argList| |$FormalMapVariableList|
                           |argml|))
              (SPADLET |functorFormWithDecl|
                       (CONS |op|
                             (PROG (G166872)
                               (SPADLET G166872 NIL)
                               (RETURN
                                 (DO ((G166878 |argList|
                                       (CDR G166878))
                                      (|a| NIL)
                                      (G166879 |argml|
                                       (CDR G166879))
                                      (|m| NIL))
                                     ((OR (ATOM G166878)
                                       (PROGN
                                         (SETQ |a| (CAR G166878))
                                         NIL)
                                       (ATOM G166879)
                                       (PROGN
                                         (SETQ |m| (CAR G166879))
                                         NIL))
                                      (NREVERSE0 G166872))
                                   (SEQ
                                    (EXIT
                                     (SETQ G166872
                                      (CONS
                                       (CONS '|:|
                                        (CONS |a| (CONS |m| NIL)))
                                       G166872)))))))))
              (|sayBrightly|
                  (|concat|
                      (|bright|
                          (|form2StringWithWhere|
                              |functorFormWithDecl|))
                      (MAKESTRING " is a") (|bright| |typ|)
                      (MAKESTRING "constructor")))
              (|sayBrightly|
                  (CONS (MAKESTRING " Abbreviation for")
                        (APPEND (|bright| |op|)
                                (CONS (MAKESTRING "is")
                                      (|bright| |fn|)))))
              (SPADLET |verb|
                       (COND
                         ((|isExposedConstructor| |op|)
                          (MAKESTRING "is"))
                         ('T (MAKESTRING "is not"))))
              (|sayBrightly|
                  (CONS (MAKESTRING " This constructor")
                        (APPEND (|bright| |verb|)
                                (CONS (MAKESTRING
                                       "exposed in this frame.")
                                      NIL))))
              (SPADLET |sourceFile| (GETDATABASE |op| 'SOURCEFILE))
              (|sayBrightly|
                  (CONS (MAKESTRING " Issue")
                        (APPEND (|bright|
                                    (STRCONC (MAKESTRING ")edit ")
                                     (|namestring| |sourceFile|)))
                                (CONS (MAKESTRING
                                       "to see algebra source code for")
                                      (APPEND (|bright| |fn|)
                                       (CONS '|%l| NIL))))))
              (DO ((G166896 |$options| (CDR G166896))
                   (G166863 NIL))
                  ((OR (ATOM G166896)
                       (PROGN (SETQ G166863 (CAR G166896)) NIL)
                       (PROGN
                         (PROGN
                           (SPADLET |opt| (CAR G166863))
                           G166863)
                         NIL))
                   NIL)
                (SEQ (EXIT (PROGN
                             (SPADLET |opt|
                                      (|selectOptionLC| |opt|
                                       |$showOptions| '|optionError|))
                             (COND
                               ((BOOT-EQUAL |opt| '|layout|)
                                (|dc1| |fn|))
                               ((BOOT-EQUAL |opt| '|views|)
                                (|sayBrightly|
                                    (CONS (MAKESTRING "To get")
                                     (APPEND
                                      (|bright| (MAKESTRING "views"))
                                      (CONS
                                       (MAKESTRING
                                     "you must give parameters of constructor")
                                       NIL)))))
                               ((BOOT-EQUAL |opt| '|attributes|)
                                (|centerAndHighlight|
                                    (MAKESTRING "Attributes")
                                    $LINELENGTH
                                    (|specialChar| '|hbar|))
                                (|sayBrightly| (MAKESTRING ""))
                                (SPADLET |attList|
                                         (REMDUP
                                          (MSORT
                                           (PROG (G166908)
                                             (SPADLET G166908 NIL)
                                             (RETURN
                                               (DO
                                                ((G166914
                                                  (GETDATABASE |op|
                                                   'ATTRIBUTES)
                                                  (CDR G166914))
                                                 (G166858 NIL))
                                                ((OR (ATOM G166914)
                                                  (PROGN
                                                    (SETQ G166858
                                                     (CAR G166914))
                                                    NIL)
                                                  (PROGN
                                                    (PROGN
                                                      (SPADLET |x|
                                                       (CAR G166858))
                                                      G166858)
                                                    NIL))
                                                 (NREVERSE0 G166908))
                                                 (SEQ
                                                  (EXIT
                                                   (SETQ G166908
                                                    (CONS |x|
                                                     G166908))))))))))
                                (COND
                                  ((NULL |attList|)
                                   (|sayBrightly|
                                    (|concat| '|%b|
                                     (|form2String| |functorForm|)
                                     '|%d| '|has no attributes.| '|%l|)))
                                  ('T
                                   (|say2PerLine|
                                    (PROG (G166925)
                                      (SPADLET G166925 NIL)
                                      (RETURN
                                        (DO
                                         ((G166930 |attList|
                                           (CDR G166930))
                                          (|x| NIL))
                                         ((OR (ATOM G166930)
                                           (PROGN
                                             (SETQ |x| (CAR G166930))
                                             NIL))
                                          (NREVERSE0 G166925))
                                          (SEQ
                                           (EXIT
                                            (SETQ G166925
                                             (CONS
                                              (|formatAttribute| |x|)
                                              G166925))))))))
                                   NIL)))
                               ((BOOT-EQUAL |opt| '|operations|)
                                (|displayOperationsFromLisplib|
                                    |functorForm|))
                               ('T NIL))))))))))))

;displayOperationsFromLisplib form ==
;  [name,:argl] := form
;  kind := GETDATABASE(name,'CONSTRUCTORKIND)
;  centerAndHighlight('"Operations",$LINELENGTH,specialChar 'hbar)
;  opList:= GETDATABASE(name,'OPERATIONALIST)
;  null opList => reportOpsFromUnitDirectly form
;  opl:=REMDUP MSORT EQSUBSTLIST(argl,$FormalMapVariableList,opList)
;  ops:= nil
;  for x in opl repeat
;    ops := [:ops,:formatOperationAlistEntry(x)]
;  say2PerLine ops
;  nil

(DEFUN |displayOperationsFromLisplib| (|form|)
  (PROG (|name| |argl| |kind| |opList| |opl| |ops|)
  (declare (special |$FormalMapVariableList| $LINELENGTH))
    (RETURN
      (SEQ (PROGN
             (SPADLET |name| (CAR |form|))
             (SPADLET |argl| (CDR |form|))
             (SPADLET |kind| (GETDATABASE |name| 'CONSTRUCTORKIND))
             (|centerAndHighlight| (MAKESTRING "Operations")
                 $LINELENGTH (|specialChar| '|hbar|))
             (SPADLET |opList| (GETDATABASE |name| 'OPERATIONALIST))
             (COND
               ((NULL |opList|) (|reportOpsFromUnitDirectly| |form|))
               ('T
                (SPADLET |opl|
                         (REMDUP (MSORT (EQSUBSTLIST |argl|
                                         |$FormalMapVariableList|
                                         |opList|))))
                (SPADLET |ops| NIL)
                (DO ((G166964 |opl| (CDR G166964)) (|x| NIL))
                    ((OR (ATOM G166964)
                         (PROGN (SETQ |x| (CAR G166964)) NIL))
                     NIL)
                  (SEQ (EXIT (SPADLET |ops|
                                      (APPEND |ops|
                                       (|formatOperationAlistEntry|
                                        |x|))))))
                (|say2PerLine| |ops|) NIL)))))))

;--% )synonym
;synonym(:l) == synonymSpad2Cmd()  -- always passed a null list

(DEFUN |synonym| (&REST G166983 &AUX |l|)
  (DSETQ |l| G166983)
  (|synonymSpad2Cmd|))

;synonymSpad2Cmd() ==
;  line := getSystemCommandLine()
;  if line = '"" then printSynonyms(NIL)
;  else
;    pair := processSynonymLine line
;    if $CommandSynonymAlist then
;      PUTALIST($CommandSynonymAlist,CAR pair, CDR pair)
;    else $CommandSynonymAlist := [pair]
;  terminateSystemCommand()

(DEFUN |synonymSpad2Cmd| ()
  (PROG (|line| |pair|)
  (declare (special |$CommandSynonymAlist|))
    (RETURN
      (PROGN
        (SPADLET |line| (|getSystemCommandLine|))
        (COND
          ((BOOT-EQUAL |line| (MAKESTRING "")) (|printSynonyms| NIL))
          ('T (SPADLET |pair| (|processSynonymLine| |line|))
           (COND
             (|$CommandSynonymAlist|
                 (PUTALIST |$CommandSynonymAlist| (CAR |pair|)
                     (CDR |pair|)))
             ('T (SPADLET |$CommandSynonymAlist| (CONS |pair| NIL))))))
        (|terminateSystemCommand|)))))

;processSynonymLine line ==
;  key := STRING2ID_-N (line, 1)
;  value := removeKeyFromLine line where
;    removeKeyFromLine line ==
;      line := dropLeadingBlanks line
;      mx := MAXINDEX line
;      for i in 0..mx repeat
;        line.i = " " =>
;          return (for j in (i+1)..mx repeat
;            line.j ^= " " => return (SUBSTRING (line, j, nil)))
;  [key, :value]

(DEFUN |processSynonymLine,removeKeyFromLine| (|line|)
  (PROG (|mx|)
    (RETURN
      (SEQ (SPADLET |line| (|dropLeadingBlanks| |line|))
           (SPADLET |mx| (MAXINDEX |line|))
           (EXIT (DO ((|i| 0 (QSADD1 |i|))) ((QSGREATERP |i| |mx|) NIL)
                   (SEQ (EXIT (IF (BOOT-EQUAL (ELT |line| |i|) '| |)
                                  (EXIT (RETURN
                                          (DO
                                           ((|j| (PLUS |i| 1)
                                             (+ |j| 1)))
                                           ((> |j| |mx|) NIL)
                                            (SEQ
                                             (EXIT
                                              (IF
                                               (NEQUAL (ELT |line| |j|)
                                                '| |)
                                               (EXIT
                                                (RETURN
                                                  (SUBSTRING |line| |j|
                                                   NIL))))))))))))))))))


(DEFUN |processSynonymLine| (|line|)
  (PROG (|key| |value|)
    (RETURN
      (PROGN
        (SPADLET |key| (STRING2ID-N |line| 1))
        (SPADLET |value|
                 (|processSynonymLine,removeKeyFromLine| |line|))
        (CONS |key| |value|)))))

;printSynonyms(patterns) ==
;  centerAndHighlight("System Command Synonyms",$LINELENGTH,specialChar 'hbar)
;  ls := filterListOfStringsWithFn(patterns, [[STRINGIMAGE a,:b]
;    for [a,:b] in synonymsForUserLevel $CommandSynonymAlist],
;      function CAR)
;  printLabelledList(ls,'"user",'"synonyms",'")",patterns)
;  nil

(DEFUN |printSynonyms| (|patterns|)
  (PROG (|a| |b| |ls|)
  (declare (special |$CommandSynonymAlist| $LINELENGTH))
    (RETURN
      (SEQ (PROGN
             (|centerAndHighlight| '|System Command Synonyms|
                 $LINELENGTH (|specialChar| '|hbar|))
             (SPADLET |ls|
                      (|filterListOfStringsWithFn| |patterns|
                          (PROG (G167027)
                            (SPADLET G167027 NIL)
                            (RETURN
                              (DO ((G167033
                                    (|synonymsForUserLevel|
                                     |$CommandSynonymAlist|)
                                    (CDR G167033))
                                   (G167017 NIL))
                                  ((OR (ATOM G167033)
                                    (PROGN
                                      (SETQ G167017 (CAR G167033))
                                      NIL)
                                    (PROGN
                                      (PROGN
                                        (SPADLET |a| (CAR G167017))
                                        (SPADLET |b| (CDR G167017))
                                        G167017)
                                      NIL))
                                   (NREVERSE0 G167027))
                                (SEQ (EXIT
                                      (SETQ G167027
                                       (CONS
                                        (CONS (STRINGIMAGE |a|) |b|)
                                        G167027)))))))
                          (|function| CAR)))
             (|printLabelledList| |ls| (MAKESTRING "user")
                 (MAKESTRING "synonyms") (MAKESTRING ")") |patterns|)
             NIL)))))

;printLabelledList(ls,label1,label2,prefix,patterns) ==
;  -- prefix goes before each element on each side of the list, eg,
;  --   ")"
;  null ls =>
;    null patterns =>
;      sayMessage ['"   No ",label1,'"-defined ",label2,'" in effect."]
;    sayMessage ['"   No ",label1,'"-defined ",label2,'" satisfying patterns:",
;     '%l,'"     ",'%b,:blankList patterns,'%d]
;  if patterns then
;    sayMessage [label1,'"-defined ",label2,'" satisfying patterns:",
;     '%l,'"   ",'%b,:blankList patterns,'%d]
;  for [syn,:comm] in ls repeat
;    if SUBSTRING(syn,0,1) = '"|" then syn := SUBSTRING(syn,1,NIL)
;    if syn = '"%i" then syn := '"%i "
;    wid := MAX(30 - (entryWidth syn),1)
;    sayBrightly concat('%b,prefix,syn,'%d,
;      fillerSpaces(wid,'"."),'" ",prefix,comm)
;  sayBrightly '""

(DEFUN |printLabelledList| (|ls| |label1| |label2| |prefix| |patterns|)
  (PROG (|comm| |syn| |wid|)
    (RETURN
      (SEQ (COND
             ((NULL |ls|)
              (COND
                ((NULL |patterns|)
                 (|sayMessage|
                     (CONS (MAKESTRING "   No ")
                           (CONS |label1|
                                 (CONS (MAKESTRING "-defined ")
                                       (CONS |label2|
                                        (CONS
                                         (MAKESTRING " in effect.")
                                         NIL)))))))
                ('T
                 (|sayMessage|
                     (CONS (MAKESTRING "   No ")
                           (CONS |label1|
                                 (CONS (MAKESTRING "-defined ")
                                       (CONS |label2|
                                        (CONS
                                         (MAKESTRING
                                          " satisfying patterns:")
                                         (CONS '|%l|
                                          (CONS (MAKESTRING "     ")
                                           (CONS '|%b|
                                            (APPEND
                                             (|blankList| |patterns|)
                                             (CONS '|%d| NIL))))))))))))))
             ('T
              (COND
                (|patterns|
                    (|sayMessage|
                        (CONS |label1|
                              (CONS (MAKESTRING "-defined ")
                                    (CONS |label2|
                                     (CONS
                                      (MAKESTRING
                                       " satisfying patterns:")
                                      (CONS '|%l|
                                       (CONS (MAKESTRING "   ")
                                        (CONS '|%b|
                                         (APPEND
                                          (|blankList| |patterns|)
                                          (CONS '|%d| NIL))))))))))))
              (DO ((G167062 |ls| (CDR G167062)) (G167049 NIL))
                  ((OR (ATOM G167062)
                       (PROGN (SETQ G167049 (CAR G167062)) NIL)
                       (PROGN
                         (PROGN
                           (SPADLET |syn| (CAR G167049))
                           (SPADLET |comm| (CDR G167049))
                           G167049)
                         NIL))
                   NIL)
                (SEQ (EXIT (PROGN
                             (COND
                               ((BOOT-EQUAL (SUBSTRING |syn| 0 1)
                                    (MAKESTRING "|"))
                                (SPADLET |syn| (SUBSTRING |syn| 1 NIL))))
                             (COND
                               ((BOOT-EQUAL |syn| (MAKESTRING "%i"))
                                (SPADLET |syn| (MAKESTRING "%i "))))
                             (SPADLET |wid|
                                      (MAX
                                       (SPADDIFFERENCE 30
                                        (|entryWidth| |syn|))
                                       1))
                             (|sayBrightly|
                                 (|concat| '|%b| |prefix| |syn| '|%d|
                                     (|fillerSpaces| |wid|
                                      (MAKESTRING "."))
                                     (MAKESTRING " ") |prefix| |comm|))))))
              (|sayBrightly| (MAKESTRING ""))))))))

;whatCommands(patterns) ==
;  label := STRCONC("System Commands for User Level: ",
;    STRINGIMAGE $UserLevel)
;  centerAndHighlight(label,$LINELENGTH,specialChar 'hbar)
;  l := filterListOfStrings(patterns,
;    [(STRINGIMAGE a) for a in commandsForUserLevel $systemCommands])
;  if patterns then
;    null l =>
;      sayMessage ['"No system commands at this level matching patterns:",
;        '%l,'"   ",'%b,:blankList patterns,'%d]
;    sayMessage ['"System commands at this level matching patterns:",
;      '%l,'"   ",'%b,:blankList patterns,'%d]
;  if l then
;    sayAsManyPerLineAsPossible l
;    SAY " "
;  patterns => nil  -- don't be so verbose
;  sayKeyedMsg("S2IZ0046",NIL)
;  nil

(DEFUN |whatCommands| (|patterns|)
  (PROG (|label| |l|)
  (declare (special |$systemCommands| $LINELENGTH |$UserLevel|))
    (RETURN
      (SEQ (PROGN
             (SPADLET |label|
                      (STRCONC '|System Commands for User Level: |
                               (STRINGIMAGE |$UserLevel|)))
             (|centerAndHighlight| |label| $LINELENGTH
                 (|specialChar| '|hbar|))
             (SPADLET |l|
                      (|filterListOfStrings| |patterns|
                          (PROG (G167084)
                            (SPADLET G167084 NIL)
                            (RETURN
                              (DO ((G167089
                                    (|commandsForUserLevel|
                                     |$systemCommands|)
                                    (CDR G167089))
                                   (|a| NIL))
                                  ((OR (ATOM G167089)
                                    (PROGN
                                      (SETQ |a| (CAR G167089))
                                      NIL))
                                   (NREVERSE0 G167084))
                                (SEQ (EXIT
                                      (SETQ G167084
                                       (CONS (STRINGIMAGE |a|)
                                        G167084)))))))))
             (COND
               (|patterns|
                   (COND
                     ((NULL |l|)
                      (|sayMessage|
                          (CONS (MAKESTRING
                                    "No system commands at this level matching patterns:")
                                (CONS '|%l|
                                      (CONS (MAKESTRING "   ")
                                       (CONS '|%b|
                                        (APPEND
                                         (|blankList| |patterns|)
                                         (CONS '|%d| NIL))))))))
                     ('T
                      (|sayMessage|
                          (CONS (MAKESTRING
                                    "System commands at this level matching patterns:")
                                (CONS '|%l|
                                      (CONS (MAKESTRING "   ")
                                       (CONS '|%b|
                                        (APPEND
                                         (|blankList| |patterns|)
                                         (CONS '|%d| NIL)))))))))))
             (COND
               (|l| (|sayAsManyPerLineAsPossible| |l|)
                    (SAY (MAKESTRING " "))))
             (COND
               (|patterns| NIL)
               ('T (|sayKeyedMsg| 'S2IZ0046 NIL) NIL)))))))

;reportWhatOptions() ==
;  optList1:= "append"/[['%l,'"        ",x] for x in $whatOptions]
;  sayBrightly
;    ['%b,'"  )what",'%d,'"argument keywords are",'%b,:optList1,'%d,'%l,
;      '"   or abbreviations thereof.",'%l,
;        '%l,'"   Issue",'%b,'")what ?",'%d,'"for more information."]

(DEFUN |reportWhatOptions| ()
  (PROG (|optList1|)
  (declare (special |$whatOptions|))
    (RETURN
      (SEQ (PROGN
             (SPADLET |optList1|
                      (PROG (G167102)
                        (SPADLET G167102 NIL)
                        (RETURN
                          (DO ((G167107 |$whatOptions|
                                   (CDR G167107))
                               (|x| NIL))
                              ((OR (ATOM G167107)
                                   (PROGN
                                     (SETQ |x| (CAR G167107))
                                     NIL))
                               G167102)
                            (SEQ (EXIT (SETQ G167102
                                        (APPEND G167102
                                         (CONS '|%l|
                                          (CONS (MAKESTRING "        ")
                                           (CONS |x| NIL)))))))))))
             (|sayBrightly|
                 (CONS '|%b|
                       (CONS (MAKESTRING "  )what")
                             (CONS '|%d|
                                   (CONS
                                    (MAKESTRING
                                     "argument keywords are")
                                    (CONS '|%b|
                                     (APPEND |optList1|
                                      (CONS '|%d|
                                       (CONS '|%l|
                                        (CONS
                                         (MAKESTRING
                                          "   or abbreviations thereof.")
                                         (CONS '|%l|
                                          (CONS '|%l|
                                           (CONS
                                            (MAKESTRING "   Issue")
                                            (CONS '|%b|
                                             (CONS
                                              (MAKESTRING ")what ?")
                                              (CONS '|%d|
                                               (CONS
                                                (MAKESTRING
                                                 "for more information.")
                                                NIL))))))))))))))))))))))

;filterListOfStrings(patterns,names) ==
;  -- names and patterns are lists of strings
;  -- returns: list of strings in names that contains any of the strings
;  -- in patterns
;  (null patterns) or (null names) => names
;  names' := NIL
;  for name in reverse names repeat
;    satisfiesRegularExpressions(name,patterns) =>
;      names' := [name,:names']
;  names'

(DEFUN |filterListOfStrings| (|patterns| |names|)
  (PROG (|names'|)
    (RETURN
      (SEQ (COND
             ((OR (NULL |patterns|) (NULL |names|)) |names|)
             ('T (SPADLET |names'| NIL)
              (SEQ (DO ((G167122 (REVERSE |names|) (CDR G167122))
                        (|name| NIL))
                       ((OR (ATOM G167122)
                            (PROGN (SETQ |name| (CAR G167122)) NIL))
                        NIL)
                     (SEQ (EXIT (COND
                                  ((|satisfiesRegularExpressions|
                                    |name| |patterns|)
                                   (EXIT
                                    (SPADLET |names'|
                                     (CONS |name| |names'|))))))))
                   (EXIT |names'|))))))))

;filterListOfStringsWithFn(patterns,names,fn) ==
;  -- names and patterns are lists of strings
;  -- fn is something like CAR or CADR
;  -- returns: list of strings in names that contains any of the strings
;  -- in patterns
;  (null patterns) or (null names) => names
;  names' := NIL
;  for name in reverse names repeat
;    satisfiesRegularExpressions(FUNCALL(fn,name),patterns) =>
;      names' := [name,:names']
;  names'

(DEFUN |filterListOfStringsWithFn| (|patterns| |names| |fn|)
  (PROG (|names'|)
    (RETURN
      (SEQ (COND
             ((OR (NULL |patterns|) (NULL |names|)) |names|)
             ('T (SPADLET |names'| NIL)
              (SEQ (DO ((G167137 (REVERSE |names|) (CDR G167137))
                        (|name| NIL))
                       ((OR (ATOM G167137)
                            (PROGN (SETQ |name| (CAR G167137)) NIL))
                        NIL)
                     (SEQ (EXIT (COND
                                  ((|satisfiesRegularExpressions|
                                    (FUNCALL |fn| |name|) |patterns|)
                                   (EXIT
                                    (SPADLET |names'|
                                     (CONS |name| |names'|))))))))
                   (EXIT |names'|))))))))

;satisfiesRegularExpressions(name,patterns) ==
;  -- this is a first cut
;  nf := true
;  dname := DOWNCASE COPY name
;  for pattern in patterns while nf repeat
;    -- use @ as a wildcard
;    STRPOS(pattern,dname,0,'"@") => nf := nil
;  null nf

(DEFUN |satisfiesRegularExpressions| (|name| |patterns|)
  (PROG (|dname| |nf|)
    (RETURN
      (SEQ (PROGN
             (SPADLET |nf| 'T)
             (SPADLET |dname| (DOWNCASE (COPY |name|)))
             (SEQ (DO ((G167153 |patterns| (CDR G167153))
                       (|pattern| NIL))
                      ((OR (ATOM G167153)
                           (PROGN
                             (SETQ |pattern| (CAR G167153))
                             NIL)
                           (NULL |nf|))
                       NIL)
                    (SEQ (EXIT (COND
                                 ((STRPOS |pattern| |dname| 0
                                          (MAKESTRING "@"))
                                  (EXIT (SPADLET |nf| NIL)))))))
                  (NULL |nf|)))))))

;;;     ***       |processSynonyms| REDEFINED

;-- functions for interfacing to system commands from algebra code
;-- common lisp dependent
;tabsToBlanks s ==
;   k := charPosition($charTab,s,0)
;   n := #s
;   k < n =>
;      k = 0 => tabsToBlanks SUBSTRING(s,1,nil)
;      STRCONC(SUBSTRING(s,0,k),$charBlank, tabsToBlanks SUBSTRING(s,k + 1,nil))
;   s

(DEFUN |tabsToBlanks| (|s|)
  (PROG (|k| |n|)
  (declare (special |$charBlank| |$charTab|))
    (RETURN
      (PROGN
        (SPADLET |k| (|charPosition| |$charTab| |s| 0))
        (SPADLET |n| (|#| |s|))
        (COND
          ((> |n| |k|)
           (COND
             ((EQL |k| 0) (|tabsToBlanks| (SUBSTRING |s| 1 NIL)))
             ('T
              (STRCONC (SUBSTRING |s| 0 |k|) |$charBlank|
                       (|tabsToBlanks|
                           (SUBSTRING |s| (PLUS |k| 1) NIL))))))
          ('T |s|))))))

;npboot str ==
;  sex := string2BootTree str
;  FORMAT(true, '"~&~S~%", sex)
;  $ans := EVAL sex
;  FORMAT(true, '"~&Value = ~S~%", $ans)

(DEFUN |npboot| (|str|)
  (PROG (|sex|)
  (declare (special |$ans|))
    (RETURN
      (PROGN
        (SPADLET |sex| (|string2BootTree| |str|))
        (FORMAT 'T (MAKESTRING "~&~S~%") |sex|)
        (SPADLET |$ans| (EVAL |sex|))
        (FORMAT 'T (MAKESTRING "~&Value = ~S~%") |$ans|)))))

;ltrace l == trace l

(DEFUN |ltrace| (|l|) (|trace| |l|)) 

@
\eject
\begin{thebibliography}{99}
\bibitem{1} [[src/interp/setq.lisp.pamphlet]]
\end{thebibliography}
\end{document}
